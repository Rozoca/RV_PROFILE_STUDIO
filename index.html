<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RV Profile Studio | Career Intelligence</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@400;500;600;700&family=DM+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <style>
        :root {
            --gold-50: #fefdfb; --gold-100: #fdf9f0; --gold-200: #f9f0db;
            --gold-400: #e4c378; --gold-500: #d4a853; --gold-600: #c4943f; --gold-700: #a37633;
            --slate-100: #f1f5f9; --slate-200: #e2e8f0; --slate-300: #cbd5e1;
            --slate-400: #94a3b8; --slate-500: #64748b; --slate-600: #475569;
            --slate-700: #334155; --slate-800: #1e293b; --slate-900: #0f172a;
            --bg-primary: var(--gold-50); --bg-card: #ffffff;
            --text-primary: var(--slate-900); --text-secondary: var(--slate-600); --text-muted: var(--slate-400);
            --brand: var(--gold-600); --brand-dark: var(--gold-700); --brand-light: var(--gold-200);
            --success: #059669; --success-bg: #ecfdf5;
            --warning: #d97706; --warning-bg: #fffbeb;
            --danger: #dc2626; --danger-bg: #fef2f2;
            --info: #0284c7; --info-bg: #f0f9ff;
            --font-display: 'Cormorant Garamond', Georgia, serif;
            --font-body: 'DM Sans', -apple-system, sans-serif;
            --space-xs: 4px; --space-sm: 8px; --space-md: 16px; --space-lg: 24px; --space-xl: 32px; --space-2xl: 48px;
            --radius-sm: 6px; --radius-md: 12px; --radius-lg: 20px;
            --shadow-md: 0 4px 12px rgba(0,0,0,0.06); --shadow-lg: 0 12px 40px rgba(0,0,0,0.08);
            --transition: 0.25s cubic-bezier(0.4, 0, 0.2, 1);
        }
        [data-theme="dark"] {
            --bg-primary: #0c0c0c; --bg-card: #161616;
            --text-primary: #f1f5f9; --text-secondary: #94a3b8; --text-muted: #64748b;
            --brand-light: rgba(212, 168, 83, 0.15);
            --success-bg: rgba(5, 150, 105, 0.15); --warning-bg: rgba(217, 119, 6, 0.15);
            --danger-bg: rgba(220, 38, 38, 0.15); --info-bg: rgba(2, 132, 199, 0.15);
        }
        *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: var(--font-body); font-size: 16px; line-height: 1.7;
            color: var(--text-primary); background: var(--bg-primary); min-height: 100vh;
            transition: background var(--transition), color var(--transition);
        }
        h1, h2, h3, h4 { font-family: var(--font-display); font-weight: 600; line-height: 1.3; }
        ::selection { background: var(--brand); color: white; }
        
        .app-wrapper { max-width: 1100px; margin: 0 auto; padding: var(--space-lg); }
        @media (min-width: 768px) { .app-wrapper { padding: var(--space-2xl); } }
        
        /* Header */
        .header {
            display: flex; justify-content: space-between; align-items: center;
            padding: var(--space-lg) 0; margin-bottom: var(--space-xl);
            border-bottom: 1px solid var(--brand-light);
        }
        .logo { display: flex; align-items: baseline; gap: var(--space-xs); }
        .logo-mark { font-family: var(--font-display); font-size: 2.2rem; font-weight: 700; color: var(--brand); }
        .logo-text { font-family: var(--font-display); font-size: 1.4rem; color: var(--text-primary); letter-spacing: 1px; }
        .header-controls { display: flex; align-items: center; gap: var(--space-md); }
        .lang-select, .theme-toggle {
            font-family: var(--font-body); font-size: 0.875rem; padding: var(--space-sm) var(--space-md);
            border: 1px solid var(--text-muted); border-radius: var(--radius-sm);
            background: transparent; color: var(--text-primary); cursor: pointer;
        }
        .theme-toggle { width: 40px; height: 40px; font-size: 1.1rem; display: flex; align-items: center; justify-content: center; }
        
        /* Panels */
        .panel { display: none; animation: fadeIn 0.4s ease; }
        .panel.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(12px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Cards */
        .card {
            background: var(--bg-card); border-radius: var(--radius-lg); padding: var(--space-xl);
            margin-bottom: var(--space-lg); box-shadow: var(--shadow-md);
            border: 1px solid rgba(0,0,0,0.04);
        }
        [data-theme="dark"] .card { border-color: rgba(255,255,255,0.05); }
        .card-title { font-size: 1.35rem; margin-bottom: var(--space-sm); display: flex; align-items: center; gap: var(--space-sm); }
        .card-subtitle { font-size: 0.9rem; color: var(--text-secondary); margin-bottom: var(--space-lg); }
        
        /* Forms */
        .form-group { margin-bottom: var(--space-lg); }
        .form-label { display: block; font-weight: 500; font-size: 0.9rem; margin-bottom: var(--space-sm); }
        .form-input, .form-textarea {
            width: 100%; padding: var(--space-md); font-family: var(--font-body); font-size: 1rem;
            color: var(--text-primary); background: var(--bg-primary);
            border: 1px solid var(--slate-300); border-radius: var(--radius-md); transition: all var(--transition);
        }
        [data-theme="dark"] .form-input, [data-theme="dark"] .form-textarea { border-color: var(--slate-700); }
        .form-input:focus, .form-textarea:focus { outline: none; border-color: var(--brand); box-shadow: 0 0 0 3px var(--brand-light); }
        .form-textarea { min-height: 200px; resize: vertical; line-height: 1.6; }
        .form-hint { font-size: 0.8rem; color: var(--text-muted); margin-top: var(--space-xs); }
        
        /* Option Grid */
        .option-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(155px, 1fr)); gap: var(--space-sm); }
        .option-pill {
            padding: var(--space-md); border: 1px solid var(--slate-300); border-radius: var(--radius-md);
            text-align: center; font-size: 0.85rem; font-weight: 500; cursor: pointer;
            transition: all var(--transition); background: var(--bg-card);
        }
        [data-theme="dark"] .option-pill { border-color: var(--slate-700); }
        .option-pill:hover { border-color: var(--brand); color: var(--brand); }
        .option-pill.selected { background: var(--brand); border-color: var(--brand); color: white; }
        
        /* Buttons */
        .btn {
            display: inline-flex; align-items: center; justify-content: center; gap: var(--space-sm);
            padding: var(--space-md) var(--space-xl); font-family: var(--font-body); font-size: 1rem;
            font-weight: 600; border-radius: var(--radius-md); cursor: pointer; transition: all var(--transition); border: none;
        }
        .btn-primary { background: var(--brand); color: white; width: 100%; }
        .btn-primary:hover { background: var(--brand-dark); transform: translateY(-2px); }
        .btn-primary:disabled { background: var(--text-muted); cursor: not-allowed; transform: none; }
        .btn-secondary { background: transparent; border: 2px solid var(--brand); color: var(--brand); }
        .btn-secondary:hover { background: var(--brand-light); }
        .btn-ghost { background: transparent; color: var(--text-secondary); padding: var(--space-sm) var(--space-md); }
        .btn-ghost:hover { color: var(--brand); background: var(--brand-light); }
        .btn-success { background: var(--success); color: white; }
        .btn-success:hover { background: #047857; }
        .btn-group { display: flex; gap: var(--space-md); margin-top: var(--space-lg); flex-wrap: wrap; }
        .btn-group .btn { flex: 1; min-width: 200px; }
        
        /* Results Header */
        .results-header {
            text-align: center; padding: var(--space-2xl) var(--space-lg);
            background: var(--bg-card); border-radius: var(--radius-lg); margin-bottom: var(--space-lg);
        }
        .results-brand { margin-bottom: var(--space-lg); }
        .results-date { font-size: 0.85rem; color: var(--text-muted); margin-bottom: var(--space-md); }
        .score-circle { position: relative; width: 200px; height: 200px; margin: 0 auto var(--space-lg); }
        .score-canvas { position: absolute; top: 0; left: 0; }
        .score-value {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            font-family: var(--font-display); font-size: 3.5rem; font-weight: 700; color: var(--brand);
        }
        .score-label { font-size: 1.1rem; color: var(--text-secondary); margin-bottom: var(--space-md); }
        .score-interpretation {
            display: inline-block; padding: var(--space-sm) var(--space-lg);
            background: var(--brand-light); border-radius: var(--radius-lg); font-weight: 600; color: var(--brand-dark);
        }
        .profile-meta {
            display: flex; justify-content: center; gap: var(--space-xl); margin-top: var(--space-lg);
            padding-top: var(--space-lg); border-top: 1px solid var(--slate-200); flex-wrap: wrap;
        }
        .meta-item { text-align: center; }
        .meta-label { font-size: 0.75rem; text-transform: uppercase; letter-spacing: 1px; color: var(--text-muted); margin-bottom: var(--space-xs); }
        .meta-value { font-weight: 600; }
        
        /* Dashboard */
        .dashboard-grid { display: grid; gap: var(--space-lg); }
        @media (min-width: 768px) { .dashboard-grid { grid-template-columns: 1fr 1fr; } }
        
        /* Metrics */
        .metric-item { display: flex; align-items: center; gap: var(--space-md); margin-bottom: var(--space-md); }
        .metric-label { width: 140px; font-size: 0.85rem; font-weight: 500; flex-shrink: 0; }
        .metric-bar { flex-grow: 1; height: 12px; background: var(--slate-200); border-radius: 6px; overflow: hidden; }
        [data-theme="dark"] .metric-bar { background: var(--slate-700); }
        .metric-fill { height: 100%; border-radius: 6px; transition: width 1s ease; }
        .metric-value { width: 50px; text-align: right; font-weight: 600; font-size: 0.9rem; }
        
        /* SWOT */
        .swot-grid { display: grid; grid-template-columns: 1fr 1fr; gap: var(--space-md); }
        @media (max-width: 600px) { .swot-grid { grid-template-columns: 1fr; } }
        .swot-card { padding: var(--space-lg); border-radius: var(--radius-md); }
        .swot-strengths { background: var(--success-bg); border-left: 4px solid var(--success); }
        .swot-weaknesses { background: var(--danger-bg); border-left: 4px solid var(--danger); }
        .swot-opportunities { background: var(--info-bg); border-left: 4px solid var(--info); }
        .swot-threats { background: var(--warning-bg); border-left: 4px solid var(--warning); }
        .swot-title { font-size: 1rem; font-weight: 600; margin-bottom: var(--space-md); display: flex; align-items: center; gap: var(--space-sm); }
        .swot-list { list-style: none; }
        .swot-list li { position: relative; padding-left: var(--space-lg); margin-bottom: var(--space-sm); font-size: 0.9rem; line-height: 1.6; }
        .swot-list li::before { content: ''; position: absolute; left: 0; top: 10px; width: 6px; height: 6px; border-radius: 50%; background: currentColor; }
        
        /* Recommendations */
        .rec-list { list-style: none; }
        .rec-item { display: flex; gap: var(--space-md); padding: var(--space-md); background: var(--bg-primary); border-radius: var(--radius-md); margin-bottom: var(--space-sm); }
        .rec-priority { width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 0.8rem; flex-shrink: 0; }
        .rec-priority.high { background: var(--danger); color: white; }
        .rec-priority.medium { background: var(--warning); color: white; }
        .rec-priority.low { background: var(--success); color: white; }
        .rec-content { flex-grow: 1; }
        .rec-title { font-weight: 600; font-size: 0.95rem; margin-bottom: 2px; }
        .rec-desc { font-size: 0.85rem; color: var(--text-secondary); line-height: 1.5; }
        
        /* Tags */
        .tag-list { display: flex; flex-wrap: wrap; gap: var(--space-sm); }
        .tag { padding: var(--space-xs) var(--space-md); border-radius: var(--radius-lg); font-size: 0.8rem; font-weight: 500; }
        .tag.match { background: var(--success-bg); color: var(--success); }
        .tag.gap { background: var(--danger-bg); color: var(--danger); }
        
        /* Synthesis */
        .synthesis-text { font-size: 1rem; line-height: 1.9; color: var(--text-secondary); }
        .synthesis-text strong { color: var(--text-primary); font-weight: 600; }
        
        /* Chart */
        .chart-container { position: relative; height: 280px; margin-bottom: var(--space-lg); }
        
        /* Job Fit Section */
        .jobfit-card { border: 2px solid var(--info); }
        .jobfit-header { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: var(--space-md); }
        .jobfit-score { font-family: var(--font-display); font-size: 2.5rem; font-weight: 700; color: var(--info); }
        .fit-grid { display: grid; gap: var(--space-lg); margin-top: var(--space-lg); }
        @media (min-width: 768px) { .fit-grid { grid-template-columns: 1fr 1fr; } }
        .fit-section-title { font-size: 0.85rem; font-weight: 600; text-transform: uppercase; letter-spacing: 1px; color: var(--text-muted); margin-bottom: var(--space-md); }
        
        /* CTA */
        .cta-card { background: linear-gradient(135deg, var(--brand) 0%, var(--brand-dark) 100%); color: white; text-align: center; }
        .cta-card .card-title { color: white; justify-content: center; }
        .cta-card p { opacity: 0.9; margin-bottom: var(--space-lg); }
        .cta-card .btn { background: white; color: var(--brand-dark); }
        
        /* Footer */
        .results-footer { text-align: center; padding: var(--space-lg); margin-top: var(--space-lg); border-top: 1px solid var(--slate-200); font-size: 0.85rem; color: var(--text-muted); }
        .results-footer a { color: var(--brand); }
        
        /* Loading */
        .loader-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.95); z-index: 9999;
            display: none; justify-content: center; align-items: center; flex-direction: column;
        }
        [data-theme="dark"] .loader-overlay { background: rgba(0,0,0,0.95); }
        .loader-overlay.active { display: flex; }
        .spinner { width: 56px; height: 56px; border: 4px solid var(--brand-light); border-top-color: var(--brand); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .loader-text { margin-top: var(--space-lg); font-size: 1.1rem; color: var(--text-secondary); }
        
        /* Utilities */
        .text-success { color: var(--success); }
        .text-warning { color: var(--warning); }
        .text-danger { color: var(--danger); }
        .mt-lg { margin-top: var(--space-lg); }
        .mb-lg { margin-bottom: var(--space-lg); }
        .hidden { display: none !important; }
        
        /* Print */
        @media print {
            .header-controls, .btn-group, .cta-card, #panelInput, #jobFitInputCard { display: none !important; }
            .card { box-shadow: none !important; break-inside: avoid; }
            body { background: white !important; }
        }
        
        /* Responsive */
        @media (max-width: 600px) {
            .header { flex-direction: column; gap: var(--space-md); text-align: center; }
            .card { padding: var(--space-lg); }
            .score-value { font-size: 2.5rem; }
            .btn-group { flex-direction: column; }
            .btn-group .btn { min-width: 100%; }
        }
    </style>
</head>
<body>
    <div class="loader-overlay" id="loader">
        <div class="spinner"></div>
        <p class="loader-text" id="loaderText">Analizando perfil...</p>
    </div>

    <div class="app-wrapper">
        <header class="header">
            <div class="logo">
                <span class="logo-mark">RV</span>
                <span class="logo-text">Profile Studio</span>
            </div>
            <div class="header-controls">
                <select class="lang-select" id="langSelect" onchange="changeLang(this.value)">
                    <option value="es">Espa√±ol</option>
                    <option value="en">English</option>
                    <option value="pt">Portugu√™s</option>
                </select>
                <button class="theme-toggle" onclick="toggleTheme()"><span id="themeIcon">üåô</span></button>
            </div>
        </header>

        <!-- PANEL 1: INPUT -->
        <section class="panel active" id="panelInput">
            <div class="card">
                <h2 class="card-title">üéØ <span data-i18n="sector_title">Sector Profesional</span></h2>
                <p class="card-subtitle" data-i18n="sector_subtitle">Selecciona tu √°rea de especializaci√≥n</p>
                <div class="option-grid" id="sectorGrid"></div>
            </div>

            <div class="card">
                <h2 class="card-title">üìä <span data-i18n="level_title">Nivel de Experiencia</span></h2>
                <div class="option-grid" id="levelGrid"></div>
            </div>

            <div class="card">
                <h2 class="card-title">üìÑ <span data-i18n="cv_title">Tu Curr√≠culum</span></h2>
                <p class="card-subtitle" data-i18n="cv_subtitle">Copia y pega el contenido completo de tu CV</p>
                <div class="form-group">
                    <textarea class="form-textarea" id="cvInput" placeholder="Pega aqu√≠ el texto de tu curr√≠culum..."></textarea>
                    <div style="display: flex; justify-content: space-between; margin-top: var(--space-sm);">
                        <button class="btn-ghost" onclick="loadExample()">üìã Cargar ejemplo</button>
                        <span class="form-hint" id="charCount">0 caracteres</span>
                    </div>
                </div>
            </div>

            <button class="btn btn-primary" onclick="runProfileAnalysis()" id="analyzeBtn">
                üîç <span data-i18n="analyze_btn">Analizar mi Perfil</span>
            </button>
        </section>

        <!-- PANEL 2: RESULTS -->
        <section class="panel" id="panelResults">
            
            <!-- Action Buttons -->
            <div class="btn-group" style="margin-bottom: var(--space-xl);">
                <button class="btn btn-secondary" onclick="showInput()">
                    ‚Üê <span data-i18n="back_btn">Volver a editar</span>
                </button>
                <button class="btn btn-success" onclick="toggleJobFit()" id="jobFitToggleBtn">
                    üéØ <span data-i18n="add_jobfit">A√±adir an√°lisis de compatibilidad</span>
                </button>
                <button class="btn btn-primary" onclick="generatePDF()">
                    üì• <span data-i18n="download_pdf">Descargar PDF</span>
                </button>
            </div>

            <!-- Job Fit Input (hidden by default) -->
            <div class="card hidden" id="jobFitInputCard">
                <h2 class="card-title">üíº <span data-i18n="job_title">Descripci√≥n del Puesto</span></h2>
                <p class="card-subtitle" data-i18n="job_subtitle">Pega la oferta de trabajo para calcular tu compatibilidad</p>
                <textarea class="form-textarea" id="jobInput" placeholder="Copia aqu√≠ la descripci√≥n del puesto..."></textarea>
                <div class="btn-group">
                    <button class="btn btn-ghost" onclick="toggleJobFit()">Cancelar</button>
                    <button class="btn btn-success" onclick="runJobFitAnalysis()">üéØ Calcular compatibilidad</button>
                </div>
            </div>

            <!-- Results Content -->
            <div id="resultsContent">
                
                <!-- Header with Score -->
                <div class="results-header" id="resultsHeader">
                    <div class="results-brand">
                        <div class="logo" style="justify-content: center;">
                            <span class="logo-mark">RV</span>
                            <span class="logo-text">Profile Studio</span>
                        </div>
                    </div>
                    <p class="results-date" id="resultsDate"></p>
                    
                    <div class="score-circle">
                        <canvas id="scoreGauge" class="score-canvas" width="200" height="200"></canvas>
                        <div class="score-value" id="mainScore">0%</div>
                    </div>
                    <p class="score-label" id="scoreLabel">Puntuaci√≥n del Perfil</p>
                    <span class="score-interpretation" id="scoreInterpretation">Calculando...</span>
                    
                    <div class="profile-meta">
                        <div class="meta-item">
                            <p class="meta-label">Sector</p>
                            <p class="meta-value" id="metaSector">-</p>
                        </div>
                        <div class="meta-item">
                            <p class="meta-label">Nivel</p>
                            <p class="meta-value" id="metaLevel">-</p>
                        </div>
                        <div class="meta-item">
                            <p class="meta-label">Experiencia</p>
                            <p class="meta-value" id="metaYears">-</p>
                        </div>
                    </div>
                </div>

                <!-- Synthesis -->
                <div class="card" id="synthesisCard">
                    <h3 class="card-title">üìù S√≠ntesis Ejecutiva</h3>
                    <p class="synthesis-text" id="synthesisText"></p>
                </div>

                <div class="dashboard-grid">
                    <div>
                        <!-- Competencies -->
                        <div class="card" id="competenciesCard">
                            <h3 class="card-title">üìà Competencias</h3>
                            <div class="chart-container"><canvas id="radarChart"></canvas></div>
                            <div id="metricsContainer"></div>
                        </div>
                    </div>

                    <div>
                        <!-- SWOT -->
                        <div class="card" id="swotCard">
                            <h3 class="card-title mb-lg">üéØ An√°lisis DAFO</h3>
                            <div class="swot-grid">
                                <div class="swot-card swot-strengths">
                                    <div class="swot-title text-success">üí™ Fortalezas</div>
                                    <ul class="swot-list" id="strengthsList"></ul>
                                </div>
                                <div class="swot-card swot-weaknesses">
                                    <div class="swot-title text-danger">‚ö†Ô∏è √Åreas de mejora</div>
                                    <ul class="swot-list" id="weaknessesList"></ul>
                                </div>
                                <div class="swot-card swot-opportunities">
                                    <div class="swot-title" style="color: var(--info);">üöÄ Oportunidades</div>
                                    <ul class="swot-list" id="opportunitiesList"></ul>
                                </div>
                                <div class="swot-card swot-threats">
                                    <div class="swot-title text-warning">üîç Desaf√≠os</div>
                                    <ul class="swot-list" id="threatsList"></ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Recommendations -->
                <div class="card" id="recommendationsCard">
                    <h3 class="card-title">üéØ Plan de Acci√≥n Personalizado</h3>
                    <ul class="rec-list" id="recommendationsList"></ul>
                </div>

                <!-- Job Fit Results (shown after analysis) -->
                <div class="card jobfit-card hidden" id="jobFitResults">
                    <div class="jobfit-header">
                        <div>
                            <h3 class="card-title" style="margin-bottom: 0;">üéØ Compatibilidad con el Puesto</h3>
                            <p class="card-subtitle" style="margin-bottom: 0;" id="jobFitPosition"></p>
                        </div>
                        <div class="jobfit-score" id="jobFitScore">--%</div>
                    </div>
                    
                    <div class="fit-grid">
                        <div>
                            <p class="fit-section-title">‚úÖ Requisitos que cumples</p>
                            <div class="tag-list" id="matchingSkills"></div>
                        </div>
                        <div>
                            <p class="fit-section-title">üìö √Åreas a desarrollar</p>
                            <div class="tag-list" id="gapSkills"></div>
                        </div>
                    </div>
                    
                    <div class="mt-lg">
                        <h4 style="font-size: 1rem; margin-bottom: var(--space-sm);">üí° Estrategia para esta candidatura</h4>
                        <p class="synthesis-text" id="fitStrategy"></p>
                    </div>
                </div>

                <!-- Footer -->
                <div class="results-footer" id="resultsFooter">
                    <p>Generado con <strong>RV Profile Studio</strong> | <a href="mailto:rvprofilestudio@gmail.com">rvprofilestudio@gmail.com</a></p>
                </div>
            </div>

            <!-- CTA -->
            <div class="card cta-card mt-lg">
                <h3 class="card-title">¬øNecesitas asesoramiento experto?</h3>
                <p>Solicita una sesi√≥n estrat√©gica para revisar estos resultados en profundidad.</p>
                <button class="btn" onclick="contact()">üìß Contactar</button>
            </div>
        </section>
    </div>

    <script>
        // ============================================
        // RV PROFILE STUDIO v4.0 - PERSONALIZED ANALYSIS
        // ============================================

        const CONFIG = { email: 'rvprofilestudio@gmail.com', version: '4.0.0' };

        let state = {
            lang: 'es',
            sector: null,
            level: null,
            cv: '',
            job: '',
            profile: null,
            jobFit: null,
            extracted: null, // Extracted CV data for personalization
            charts: {}
        };

        // --- i18n (simplified) ---
        const i18n = {
            es: {
                sector_title: 'Sector Profesional', sector_subtitle: 'Selecciona tu √°rea de especializaci√≥n',
                level_title: 'Nivel de Experiencia', cv_title: 'Tu Curr√≠culum',
                cv_subtitle: 'Copia y pega el contenido completo de tu CV',
                analyze_btn: 'Analizar mi Perfil', back_btn: 'Volver a editar',
                add_jobfit: 'A√±adir an√°lisis de compatibilidad', download_pdf: 'Descargar PDF',
                job_title: 'Descripci√≥n del Puesto', job_subtitle: 'Pega la oferta de trabajo para calcular tu compatibilidad',
                loading: 'Analizando perfil...', loading_fit: 'Calculando compatibilidad...',
                error_sector: 'Selecciona un sector', error_level: 'Selecciona un nivel',
                error_cv: 'El CV debe tener al menos 100 caracteres', error_job: 'Pega la descripci√≥n del puesto',
                years: 'a√±os'
            },
            en: {
                sector_title: 'Professional Sector', sector_subtitle: 'Select your area of expertise',
                level_title: 'Experience Level', cv_title: 'Your Resume',
                cv_subtitle: 'Copy and paste your complete CV content',
                analyze_btn: 'Analyze my Profile', back_btn: 'Back to edit',
                add_jobfit: 'Add job compatibility', download_pdf: 'Download PDF',
                job_title: 'Job Description', job_subtitle: 'Paste the job offer to calculate your fit',
                loading: 'Analyzing profile...', loading_fit: 'Calculating compatibility...',
                error_sector: 'Select a sector', error_level: 'Select a level',
                error_cv: 'CV must have at least 100 characters', error_job: 'Paste the job description',
                years: 'years'
            },
            pt: {
                sector_title: 'Setor Profissional', sector_subtitle: 'Selecione sua √°rea de especializa√ß√£o',
                level_title: 'N√≠vel de Experi√™ncia', cv_title: 'Seu Curr√≠culo',
                cv_subtitle: 'Copie e cole o conte√∫do completo do seu CV',
                analyze_btn: 'Analisar meu Perfil', back_btn: 'Voltar a editar',
                add_jobfit: 'Adicionar an√°lise de compatibilidade', download_pdf: 'Baixar PDF',
                job_title: 'Descri√ß√£o da Vaga', job_subtitle: 'Cole a oferta de trabalho para calcular sua compatibilidade',
                loading: 'Analisando perfil...', loading_fit: 'Calculando compatibilidade...',
                error_sector: 'Selecione um setor', error_level: 'Selecione um n√≠vel',
                error_cv: 'O CV deve ter pelo menos 100 caracteres', error_job: 'Cole a descri√ß√£o da vaga',
                years: 'anos'
            }
        };

        function t(key) { return i18n[state.lang][key] || key; }

        // --- SECTORS ---
        const sectors = {
            pm: { label: { es: 'Project Management', en: 'Project Management', pt: 'Project Management' },
                keywords: ['project management', 'pmp', 'prince2', 'agile', 'scrum', 'kanban', 'jira', 'ms project', 'azure devops', 'waterfall', 'pmo', 'roadmap', 'milestone', 'risk management', 'stakeholder', 'budget', 'planning', 'program management'] },
            transformation: { label: { es: 'Transformaci√≥n / Change', en: 'Transformation / Change', pt: 'Transforma√ß√£o / Change' },
                keywords: ['change management', 'transformation', 'lean', 'six sigma', 'dmaic', 'kaizen', 'continuous improvement', 'process improvement', 'value stream', 'vsm', 'sipoc', 'as-is', 'to-be', 'bpr', 'operating model', 'prosci', 'adkar', 'organizational design'] },
            banking_ops: { label: { es: 'Banking Operations', en: 'Banking Operations', pt: 'Banking Operations' },
                keywords: ['banking operations', 'operations excellence', 'service delivery', 'sla', 'back office', 'middle office', 'operational risk', 'compliance', 'aml', 'kyc', 'reconciliation', 'settlement', 'bpo', 'outsourcing', 'offshoring', 'nearshoring', 'vendor management', 'core banking', 'digital banking'] },
            payments: { label: { es: 'Pagos / Treasury', en: 'Payments / Treasury', pt: 'Pagamentos / Treasury' },
                keywords: ['payments', 'treasury', 'swift', 'sepa', 'iso20022', 'iso 20022', 'target2', 'instant payments', 'correspondent banking', 'nostro', 'vostro', 'fx', 'wire transfer', 'cash management', 'liquidity', 'psd2', 'payment hub', 'cbpr+', 'euro digital', 'cbdc'] },
            product: { label: { es: 'Product Management', en: 'Product Management', pt: 'Product Management' },
                keywords: ['product management', 'product owner', 'backlog', 'user stories', 'roadmap', 'mvp', 'product strategy', 'market research', 'a/b testing', 'prioritization', 'go-to-market', 'saas', 'agile', 'scrum'] },
            tech: { label: { es: 'Tecnolog√≠a / IT', en: 'Technology / IT', pt: 'Tecnologia / TI' },
                keywords: ['software', 'development', 'programming', 'javascript', 'python', 'java', 'react', 'node', 'aws', 'azure', 'cloud', 'docker', 'kubernetes', 'devops', 'api', 'microservices', 'sql', 'database', 'architecture'] },
            finance: { label: { es: 'Finanzas', en: 'Finance', pt: 'Finan√ßas' },
                keywords: ['financial analysis', 'fp&a', 'budgeting', 'forecasting', 'reporting', 'ifrs', 'gaap', 'audit', 'controlling', 'p&l', 'balance sheet', 'consolidation', 'sap', 'oracle', 'excel'] },
            consulting: { label: { es: 'Consultor√≠a', en: 'Consulting', pt: 'Consultoria' },
                keywords: ['consulting', 'strategy', 'advisory', 'implementation', 'due diligence', 'business case', 'benchmarking', 'deliverables', 'workstreams', 'engagement'] },
            data: { label: { es: 'Data / Analytics', en: 'Data / Analytics', pt: 'Data / Analytics' },
                keywords: ['data analytics', 'business intelligence', 'bi', 'power bi', 'tableau', 'sql', 'python', 'data visualization', 'dashboards', 'kpi', 'machine learning', 'data science'] },
            hr: { label: { es: 'Recursos Humanos', en: 'Human Resources', pt: 'Recursos Humanos' },
                keywords: ['human resources', 'hr', 'talent acquisition', 'recruiting', 'onboarding', 'training', 'performance management', 'compensation', 'employee engagement', 'hrbp'] },
            marketing: { label: { es: 'Marketing', en: 'Marketing', pt: 'Marketing' },
                keywords: ['marketing', 'digital marketing', 'seo', 'sem', 'social media', 'content', 'branding', 'campaign', 'analytics', 'crm', 'hubspot'] },
            sales: { label: { es: 'Ventas / BizDev', en: 'Sales / BizDev', pt: 'Vendas / BizDev' },
                keywords: ['sales', 'business development', 'account management', 'pipeline', 'crm', 'negotiation', 'closing', 'b2b', 'b2c'] },
            legal: { label: { es: 'Legal / Compliance', en: 'Legal / Compliance', pt: 'Legal / Compliance' },
                keywords: ['legal', 'compliance', 'regulatory', 'gdpr', 'contracts', 'governance', 'risk', 'audit', 'policy'] },
            ops: { label: { es: 'Operaciones / Log√≠stica', en: 'Operations / Logistics', pt: 'Opera√ß√µes / Log√≠stica' },
                keywords: ['operations', 'logistics', 'supply chain', 'procurement', 'inventory', 'warehouse', 'lean', 'erp', 'sap'] },
            other: { label: { es: 'Otro', en: 'Other', pt: 'Outro' }, keywords: [] }
        };

        const levels = [
            { id: 'junior', label: { es: 'Junior (0-3 a√±os)', en: 'Junior (0-3 years)', pt: 'J√∫nior (0-3 anos)' }, years: [0, 3] },
            { id: 'mid', label: { es: 'Mid-Level (3-7 a√±os)', en: 'Mid-Level (3-7 years)', pt: 'Pleno (3-7 anos)' }, years: [3, 7] },
            { id: 'senior', label: { es: 'Senior (7-12 a√±os)', en: 'Senior (7-12 years)', pt: 'S√™nior (7-12 anos)' }, years: [7, 12] },
            { id: 'lead', label: { es: 'Lead / Manager (12-18 a√±os)', en: 'Lead / Manager (12-18 years)', pt: 'Lead / Manager (12-18 anos)' }, years: [12, 18] },
            { id: 'director', label: { es: 'Director / Head (18+ a√±os)', en: 'Director / Head (18+ years)', pt: 'Diretor / Head (18+ anos)' }, years: [18, 50] }
        ];

        // --- UTILITIES ---
        function showLoader(text) { document.getElementById('loaderText').textContent = text; document.getElementById('loader').classList.add('active'); }
        function hideLoader() { document.getElementById('loader').classList.remove('active'); }
        function normalize(t) { return t.toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, '').replace(/[^\w\s]/g, ' ').replace(/\s+/g, ' ').trim(); }

        // --- UI ---
        function changeLang(lang) {
            state.lang = lang;
            document.querySelectorAll('[data-i18n]').forEach(el => { el.textContent = t(el.dataset.i18n); });
            renderSectors(); renderLevels();
        }

        function toggleTheme() {
            const isDark = document.body.dataset.theme === 'dark';
            document.body.dataset.theme = isDark ? '' : 'dark';
            document.getElementById('themeIcon').textContent = isDark ? 'üåô' : '‚òÄÔ∏è';
        }

        function renderSectors() {
            const grid = document.getElementById('sectorGrid');
            grid.innerHTML = '';
            Object.entries(sectors).forEach(([key, sec]) => {
                const pill = document.createElement('div');
                pill.className = 'option-pill' + (state.sector === key ? ' selected' : '');
                pill.textContent = sec.label[state.lang];
                pill.onclick = () => { state.sector = key; renderSectors(); };
                grid.appendChild(pill);
            });
        }

        function renderLevels() {
            const grid = document.getElementById('levelGrid');
            grid.innerHTML = '';
            levels.forEach(lv => {
                const pill = document.createElement('div');
                pill.className = 'option-pill' + (state.level === lv.id ? ' selected' : '');
                pill.textContent = lv.label[state.lang];
                pill.onclick = () => { state.level = lv.id; renderLevels(); };
                grid.appendChild(pill);
            });
        }

        function showInput() {
            document.getElementById('panelInput').classList.add('active');
            document.getElementById('panelResults').classList.remove('active');
        }

        function showResults() {
            document.getElementById('panelInput').classList.remove('active');
            document.getElementById('panelResults').classList.add('active');
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function toggleJobFit() {
            const card = document.getElementById('jobFitInputCard');
            card.classList.toggle('hidden');
            if (!card.classList.contains('hidden')) {
                card.scrollIntoView({ behavior: 'smooth' });
            }
        }

        function loadExample() {
            document.getElementById('cvInput').value = `RODRIGO VIDAL
PROJECT MANAGER SENIOR | TRANSFORMATION & CHANGE MANAGEMENT
Madrid, Espa√±a ‚Ä¢ rovid25@outlook.com ‚Ä¢ +34 660 234 438

PERFIL PROFESIONAL
Project Manager Senior y L√≠der de Transformaci√≥n con +19 a√±os de trayectoria internacional, forjado en la disciplina de la Armada de Brasil y consolidado liderando proyectos complejos en el sector financiero.

Combino metodolog√≠as anal√≠ticas (Lean Management, Value Stream Mapping, Agile) con un liderazgo humanista que potencia equipos de alto rendimiento. Experto en gesti√≥n de programas de transformaci√≥n, implementaci√≥n de sistemas cr√≠ticos (SWIFT/ISO20022, SAP), offshoring y gesti√≥n del cambio organizacional.

COMPETENCIAS CLAVE
‚Ä¢ Gesti√≥n de Proyectos: Planificaci√≥n estrat√©gica, control presupuestario (+4M EUR), gesti√≥n de riesgos, Agile/Waterfall, MS Project, Azure DevOps, Jira
‚Ä¢ Transformaci√≥n & Mejora Continua: Lean Management, DMAIC, SIPOC, Value Stream Mapping, Kaizen, an√°lisis AS-IS/TO-BE
‚Ä¢ Gesti√≥n del Cambio: Change management, comunicaci√≥n estrat√©gica, formaci√≥n intercultural, offshoring
‚Ä¢ Liderazgo: Equipos hasta 15 personas, stakeholder management, mentoring, comunicaci√≥n ejecutiva
‚Ä¢ Herramientas: Power BI (Certificado), SAP, Excel/Power Query, Claude AI

EXPERIENCIA PROFESIONAL

Strategic Process Manager & Change Lead
ING Espa√±a & Portugal ‚Ä¢ Madrid ‚Ä¢ 2024 ‚Äì Presente
‚Ä¢ Offshoring Manila: Migraci√≥n estrat√©gica al HUB regional (5 personas). Reducci√≥n 80% BAU, SLA >95%, ahorro ‚Ç¨120K/a√±o
‚Ä¢ Fundador del Foro de Expertos en Pagos: Comunidad de 57 profesionales de 5 √°reas. 8 sesiones, 95% satisfacci√≥n
‚Ä¢ Euro Digital: Representante en grupos BCE/BdE. 3+ informes ejecutivos, podcast de divulgaci√≥n

Process Improvement Lead & Treasury Specialist
BME Group (SIX Group) ‚Ä¢ Madrid ‚Ä¢ 2022 ‚Äì 2024
‚Ä¢ Proyecto ISO20022 (TARGET2/CBPR+): Coordinaci√≥n de equipos t√©cnicos, roadmap de 12 meses
‚Ä¢ Value Stream Mapping: Reducci√≥n 20% tiempo de ciclo

Senior Consultant & Transformation Project Manager
Minsait (Indra) ‚Ä¢ Madrid ‚Ä¢ 2021 ‚Äì 2022
‚Ä¢ Consolidaci√≥n plataforma de pagos (+4M EUR): Migraci√≥n internacional a ISO20022
‚Ä¢ Change management para adopci√≥n cross-funcional

Product Owner ‚Äì Treasury & Cash Management
Telef√≥nica ‚Ä¢ Madrid ‚Ä¢ 2019 ‚Äì 2021
‚Ä¢ Proyecto SAP: Gesti√≥n de +200 cuentas bancarias en 20 entidades
‚Ä¢ Banco Interno del Grupo: Creaci√≥n desde cero

Head of Treasury Operations
WiZink Bank ‚Ä¢ Madrid ‚Ä¢ 2015 ‚Äì 2019
‚Ä¢ Cre√© departamento Back Office desde cero (0‚Üí6 personas en 18 meses)
‚Ä¢ Migraci√≥n a Iberclear: Ahorro anual ~‚Ç¨100K

Payment Operations Specialist
Citibank ‚Ä¢ Barcelona ‚Ä¢ 2006 ‚Äì 2015
‚Ä¢ 9 a√±os en operaciones de pagos internacionales

Oficial de Operaciones Log√≠sticas
Armada de Brasil ‚Ä¢ R√≠o de Janeiro ‚Ä¢ 1999 ‚Äì 2006

FORMACI√ìN ACAD√âMICA
‚Ä¢ M√°ster en Project Management ‚Äì OBS Business School (2023)
‚Ä¢ Executive MBA ‚Äì EAE Business School (2018)
‚Ä¢ Grado en Ciencias Pol√≠ticas ‚Äì Universitat de Barcelona (2015)

CERTIFICACIONES
‚Ä¢ Especialista Lean (DMAIC, SIPOC, VSM, Kaizen) ‚Äì FM2S (2024)
‚Ä¢ Power BI & Excel Analytics ‚Äì Bilib (2024)
‚Ä¢ SWIFT Payment Messages Professional ‚Äì SWIFT (2017)

IDIOMAS
‚Ä¢ Espa√±ol: Biling√ºe
‚Ä¢ Portugu√©s: Nativo
‚Ä¢ Ingl√©s: B2+ (Trinity College London)`;
            updateCharCount();
        }

        function updateCharCount() {
            document.getElementById('charCount').textContent = document.getElementById('cvInput').value.length + ' caracteres';
        }

        // ============================================
        // CV DATA EXTRACTION (for personalization)
        // ============================================
        function extractCVData(cvText) {
            const text = cvText;
            const textLower = text.toLowerCase();
            const textNorm = normalize(text);
            
            // Extract companies
            const companies = [];
            const companyPatterns = [
                /(?:^|\n)\s*([A-Z√Å√â√ç√ì√ö√ë][A-Za-z√°√©√≠√≥√∫√±\s&]+)\s*[‚Ä¢¬∑\-‚Äì|]\s*(?:Madrid|Barcelona|Espa√±a|Spain|Portugal|Brazil|Brasil)/gmi,
                /(?:en|at|@)\s+([A-Z][A-Za-z\s&]+?)(?:\s*[,‚Ä¢]|\s+(?:desde|from|during))/gi
            ];
            const knownCompanies = ['ING', 'BME', 'SIX Group', 'Minsait', 'Indra', 'Telef√≥nica', 'WiZink', 'Citibank', 'BBVA', 'Santander', 'CaixaBank', 'Sabadell', 'N26', 'Revolut'];
            knownCompanies.forEach(c => { if (textLower.includes(c.toLowerCase())) companies.push(c); });
            
            // Extract years of experience
            let years = 0;
            const yearsMatch = text.match(/[\+>]?\s*(\d{1,2})\s*\+?\s*(?:a√±os|years|anos)/i);
            if (yearsMatch) years = parseInt(yearsMatch[1]);
            else {
                const yearNums = [...text.matchAll(/\b(19[89]\d|20[0-2]\d)\b/g)].map(m => parseInt(m[1]));
                if (yearNums.length >= 2) years = Math.max(...yearNums) - Math.min(...yearNums);
            }
            
            // Extract metrics/achievements
            const metrics = [];
            const metricPatterns = [
                { pattern: /(\d+)\s*%\s*(?:reducci√≥n|reduction|ahorro|savings|mejora|improvement)/gi, type: 'percentage' },
                { pattern: /‚Ç¨\s*([\d,.]+)\s*[kKmM]?/g, type: 'money' },
                { pattern: /(\d+)\s*(?:personas|people|team|equipo)/gi, type: 'team' },
                { pattern: /SLA\s*[>‚â•]?\s*(\d+)%/gi, type: 'sla' },
                { pattern: /(\d+)\s*(?:proyectos|projects)/gi, type: 'projects' },
                { pattern: /ahorro[s]?\s*(?:de\s*)?[‚Ç¨$]?\s*([\d,.]+)/gi, type: 'savings' }
            ];
            metricPatterns.forEach(({ pattern }) => {
                const matches = text.match(pattern);
                if (matches) metrics.push(...matches);
            });
            
            // Extract certifications
            const certifications = [];
            const certKeywords = ['PMP', 'PRINCE2', 'Scrum Master', 'PSM', 'CSM', 'SAFe', 'Lean', 'Six Sigma', 'Green Belt', 'Black Belt', 'SWIFT', 'ISO20022', 'Power BI', 'AWS', 'Azure', 'CFA', 'ACCA'];
            certKeywords.forEach(cert => { if (textLower.includes(cert.toLowerCase())) certifications.push(cert); });
            
            // Extract education
            const education = [];
            if (textLower.match(/\b(phd|doctorado|doctorate)\b/)) education.push('Doctorado');
            if (textLower.match(/\b(executive mba|emba)\b/)) education.push('Executive MBA');
            else if (textLower.match(/\bmba\b/)) education.push('MBA');
            if (textLower.match(/\b(master|m√°ster|mestrado)\b/)) education.push('M√°ster');
            if (textLower.match(/\b(grado|degree|licenciatura|bachelor)\b/)) education.push('Grado universitario');
            
            // Extract languages
            const languages = [];
            if (textLower.match(/espa√±ol|spanish|castellano/)) languages.push('Espa√±ol');
            if (textLower.match(/ingl√©s|english/)) languages.push('Ingl√©s');
            if (textLower.match(/portugu√©s|portuguese/)) languages.push('Portugu√©s');
            if (textLower.match(/franc√©s|french/)) languages.push('Franc√©s');
            if (textLower.match(/alem√°n|german/)) languages.push('Alem√°n');
            
            // Extract language levels
            const englishLevel = textLower.match(/ingl[e√©]s[:\s]*([abc][12][\+]?|native|nativo|fluent|bilingual)/i);
            
            // Extract key skills/tools
            const tools = [];
            const toolKeywords = ['Jira', 'Confluence', 'MS Project', 'Azure DevOps', 'SAP', 'Power BI', 'Excel', 'Tableau', 'SQL', 'Python', 'SWIFT', 'Salesforce'];
            toolKeywords.forEach(tool => { if (textLower.includes(tool.toLowerCase())) tools.push(tool); });
            
            // Extract methodologies
            const methodologies = [];
            const methKeywords = ['Agile', 'Scrum', 'Kanban', 'Waterfall', 'Lean', 'Six Sigma', 'DMAIC', 'Kaizen', 'Value Stream', 'SIPOC'];
            methKeywords.forEach(m => { if (textLower.includes(m.toLowerCase())) methodologies.push(m); });
            
            // Extract specific achievements (sentences with numbers)
            const achievements = [];
            const sentences = text.split(/[.!?]\s+/);
            sentences.forEach(s => {
                if (s.match(/\d+\s*%|\d+\s*(personas|people|‚Ç¨|EUR|USD|\$|proyecto|project|ahorro|saving)/i)) {
                    const clean = s.trim().substring(0, 100);
                    if (clean.length > 20) achievements.push(clean);
                }
            });
            
            // Extract titles/roles
            const roles = [];
            const rolePatterns = ['Project Manager', 'Product Owner', 'Head of', 'Director', 'Lead', 'Manager', 'Specialist', 'Consultant', 'Analyst'];
            rolePatterns.forEach(r => { if (textLower.includes(r.toLowerCase())) roles.push(r); });
            
            return {
                companies: [...new Set(companies)].slice(0, 5),
                years,
                metrics: [...new Set(metrics)].slice(0, 8),
                certifications: [...new Set(certifications)],
                education: [...new Set(education)],
                languages,
                englishLevel: englishLevel ? englishLevel[1].toUpperCase() : null,
                tools: [...new Set(tools)],
                methodologies: [...new Set(methodologies)],
                achievements: achievements.slice(0, 5),
                roles: [...new Set(roles)]
            };
        }

        // ============================================
        // PROFILE ANALYSIS ENGINE
        // ============================================
        function analyzeProfile(cvText, sectorKey, levelId) {
            const cv = normalize(cvText);
            const sector = sectors[sectorKey];
            const level = levels.find(l => l.id === levelId);
            const extracted = extractCVData(cvText);
            state.extracted = extracted;
            
            // Calculate metrics
            const metrics = {
                experience: calculateExperience(extracted.years, level),
                education: calculateEducation(extracted, cvText),
                technical: calculateTechnical(cv, sector, extracted),
                leadership: calculateLeadership(cvText, extracted),
                achievements: calculateAchievements(extracted),
                languages: calculateLanguages(extracted)
            };
            
            // Weights by level
            const weights = {
                junior: { experience: 0.20, education: 0.25, technical: 0.25, leadership: 0.10, achievements: 0.12, languages: 0.08 },
                mid: { experience: 0.22, education: 0.18, technical: 0.25, leadership: 0.15, achievements: 0.12, languages: 0.08 },
                senior: { experience: 0.22, education: 0.14, technical: 0.22, leadership: 0.20, achievements: 0.14, languages: 0.08 },
                lead: { experience: 0.20, education: 0.12, technical: 0.18, leadership: 0.25, achievements: 0.17, languages: 0.08 },
                director: { experience: 0.18, education: 0.10, technical: 0.15, leadership: 0.28, achievements: 0.20, languages: 0.09 }
            }[levelId];
            
            let score = Object.keys(metrics).reduce((sum, k) => sum + metrics[k] * weights[k], 0);
            
            // Bonuses
            if (Object.values(metrics).every(v => v >= 70)) score += 4;
            if (Object.values(metrics).some(v => v >= 95)) score += 2;
            if (extracted.years >= 15 && (levelId === 'lead' || levelId === 'director')) score += 3;
            
            score = Math.min(98, Math.round(score));
            
            return {
                score,
                metrics,
                swot: generatePersonalizedSWOT(metrics, extracted, sector, level, state.lang),
                recommendations: generatePersonalizedRecommendations(metrics, extracted, sector, state.lang),
                synthesis: generatePersonalizedSynthesis(score, metrics, extracted, sector, level, state.lang)
            };
        }

        function calculateExperience(years, level) {
            const [min, max] = level.years;
            const expected = (min + max) / 2;
            if (years >= expected * 1.3) return 95;
            if (years >= expected) return 90;
            if (years >= expected * 0.7) return 80;
            if (years >= expected * 0.5) return 65;
            return 50;
        }

        function calculateEducation(extracted, cvText) {
            let score = 40;
            if (extracted.education.includes('Doctorado')) score = 100;
            else if (extracted.education.includes('Executive MBA')) score = 95;
            else if (extracted.education.includes('MBA')) score = 90;
            else if (extracted.education.includes('M√°ster')) score = 85;
            else if (extracted.education.includes('Grado universitario')) score = 70;
            
            if (extracted.education.length >= 2) score = Math.min(100, score + 8);
            score = Math.min(100, score + extracted.certifications.length * 4);
            
            return score;
        }

        function calculateTechnical(cvNorm, sector, extracted) {
            if (!sector.keywords.length) return 75;
            
            const matches = sector.keywords.filter(kw => cvNorm.includes(kw.toLowerCase())).length;
            const ratio = matches / Math.min(12, sector.keywords.length);
            let score = Math.min(100, 40 + ratio * 60);
            
            // Bonus for tools/methodologies
            score = Math.min(100, score + extracted.tools.length * 2);
            score = Math.min(100, score + extracted.methodologies.length * 2);
            
            return Math.round(score);
        }

        function calculateLeadership(cvText, extracted) {
            let score = 45;
            const text = cvText.toLowerCase();
            
            // Team management
            const teamMatch = text.match(/(\d+)\s*(personas|people|team|equipo)/i);
            if (teamMatch) {
                const size = parseInt(teamMatch[1]);
                if (size >= 15) score += 25;
                else if (size >= 8) score += 18;
                else if (size >= 4) score += 12;
            }
            
            // Leadership roles
            if (extracted.roles.some(r => r.match(/head|director|lead/i))) score += 15;
            if (extracted.roles.includes('Manager')) score += 10;
            
            // Leadership keywords
            const leaderWords = ['led', 'managed', 'founded', 'created', 'built', 'lider√©', 'gestion√©', 'fund√©', 'cre√©', 'constru√≠'];
            const leaderCount = leaderWords.filter(w => text.includes(w)).length;
            score += leaderCount * 3;
            
            // Stakeholder management
            if (text.includes('stakeholder')) score += 5;
            if (text.includes('cross-functional') || text.includes('transversal')) score += 5;
            
            return Math.min(100, score);
        }

        function calculateAchievements(extracted) {
            let score = 40;
            score += Math.min(30, extracted.metrics.length * 6);
            score += Math.min(20, extracted.achievements.length * 5);
            return Math.min(100, score);
        }

        function calculateLanguages(extracted) {
            let score = 40;
            score += extracted.languages.length * 12;
            
            if (extracted.englishLevel) {
                if (extracted.englishLevel.match(/C[12]|NATIVE|BILINGUAL/i)) score += 20;
                else if (extracted.englishLevel.match(/B2/i)) score += 12;
                else if (extracted.englishLevel.match(/B1/i)) score += 8;
            }
            
            return Math.min(100, score);
        }

        // ============================================
        // PERSONALIZED CONTENT GENERATION
        // ============================================
        function generatePersonalizedSWOT(metrics, extracted, sector, level, lang) {
            const swot = { strengths: [], weaknesses: [], opportunities: [], threats: [] };
            const sectorName = sector.label[lang];
            
            // --- STRENGTHS (personalized) ---
            if (extracted.years >= 15) {
                swot.strengths.push(lang === 'es' ? 
                    `S√≥lida trayectoria de ${extracted.years}+ a√±os${extracted.companies.length ? ', con experiencia en ' + extracted.companies.slice(0, 3).join(', ') : ''}` :
                    lang === 'en' ?
                    `Strong track record of ${extracted.years}+ years${extracted.companies.length ? ', with experience at ' + extracted.companies.slice(0, 3).join(', ') : ''}` :
                    `S√≥lida trajet√≥ria de ${extracted.years}+ anos${extracted.companies.length ? ', com experi√™ncia em ' + extracted.companies.slice(0, 3).join(', ') : ''}`);
            }
            
            if (extracted.education.length >= 2) {
                swot.strengths.push(lang === 'es' ? 
                    `Formaci√≥n acad√©mica destacada: ${extracted.education.join(', ')}` :
                    lang === 'en' ?
                    `Outstanding academic background: ${extracted.education.join(', ')}` :
                    `Forma√ß√£o acad√™mica destacada: ${extracted.education.join(', ')}`);
            }
            
            if (extracted.certifications.length >= 2) {
                swot.strengths.push(lang === 'es' ? 
                    `Certificaciones profesionales relevantes: ${extracted.certifications.slice(0, 4).join(', ')}` :
                    lang === 'en' ?
                    `Relevant professional certifications: ${extracted.certifications.slice(0, 4).join(', ')}` :
                    `Certifica√ß√µes profissionais relevantes: ${extracted.certifications.slice(0, 4).join(', ')}`);
            }
            
            if (extracted.methodologies.length >= 3) {
                swot.strengths.push(lang === 'es' ? 
                    `Dominio de metodolog√≠as clave: ${extracted.methodologies.slice(0, 4).join(', ')}` :
                    lang === 'en' ?
                    `Mastery of key methodologies: ${extracted.methodologies.slice(0, 4).join(', ')}` :
                    `Dom√≠nio de metodologias-chave: ${extracted.methodologies.slice(0, 4).join(', ')}`);
            }
            
            if (extracted.metrics.length >= 3) {
                swot.strengths.push(lang === 'es' ? 
                    `Historial de logros cuantificables con impacto demostrable (${extracted.metrics.slice(0, 2).join(', ')})` :
                    lang === 'en' ?
                    `Track record of quantifiable achievements with demonstrable impact (${extracted.metrics.slice(0, 2).join(', ')})` :
                    `Hist√≥rico de conquistas quantific√°veis com impacto demonstr√°vel (${extracted.metrics.slice(0, 2).join(', ')})`);
            }
            
            if (extracted.languages.length >= 3) {
                swot.strengths.push(lang === 'es' ? 
                    `Perfil multiling√ºe (${extracted.languages.join(', ')}) con proyecci√≥n internacional` :
                    lang === 'en' ?
                    `Multilingual profile (${extracted.languages.join(', ')}) with international reach` :
                    `Perfil multil√≠ngue (${extracted.languages.join(', ')}) com alcance internacional`);
            }
            
            if (metrics.leadership >= 80) {
                swot.strengths.push(lang === 'es' ? 
                    'Capacidad demostrada de liderazgo y gesti√≥n de equipos multidisciplinares' :
                    lang === 'en' ?
                    'Demonstrated leadership and cross-functional team management ability' :
                    'Capacidade demonstrada de lideran√ßa e gest√£o de equipes multidisciplinares');
            }
            
            // Ensure minimum
            while (swot.strengths.length < 3) {
                swot.strengths.push(lang === 'es' ? 'Perfil estructurado con experiencia en entornos corporativos' :
                    lang === 'en' ? 'Structured profile with corporate experience' :
                    'Perfil estruturado com experi√™ncia corporativa');
            }
            
            // --- WEAKNESSES (constructive, personalized) ---
            if (extracted.englishLevel && extracted.englishLevel.match(/B[12]/i)) {
                swot.weaknesses.push(lang === 'es' ? 
                    `Ingl√©s a nivel ${extracted.englishLevel}: considera certificaci√≥n avanzada (C1) para roles internacionales` :
                    lang === 'en' ?
                    `English at ${extracted.englishLevel} level: consider advanced certification (C1) for international roles` :
                    `Ingl√™s n√≠vel ${extracted.englishLevel}: considere certifica√ß√£o avan√ßada (C1) para fun√ß√µes internacionais`);
            }
            
            if (metrics.technical < 70) {
                const missing = sector.keywords.filter(kw => !normalize(state.cv).includes(kw.toLowerCase())).slice(0, 3);
                if (missing.length) {
                    swot.weaknesses.push(lang === 'es' ? 
                        `Oportunidad de destacar m√°s keywords del sector: ${missing.join(', ')}` :
                        lang === 'en' ?
                        `Opportunity to highlight more sector keywords: ${missing.join(', ')}` :
                        `Oportunidade de destacar mais palavras-chave do setor: ${missing.join(', ')}`);
                }
            }
            
            if (metrics.achievements < 70) {
                swot.weaknesses.push(lang === 'es' ? 
                    'Los logros podr√≠an beneficiarse de m√°s m√©tricas cuantificables (%, ‚Ç¨, tiempo)' :
                    lang === 'en' ?
                    'Achievements could benefit from more quantifiable metrics (%, ‚Ç¨, time)' :
                    'As conquistas poderiam se beneficiar de mais m√©tricas quantific√°veis (%, ‚Ç¨, tempo)');
            }
            
            if (extracted.tools.length < 3) {
                swot.weaknesses.push(lang === 'es' ? 
                    'Considera mencionar m√°s herramientas espec√≠ficas utilizadas en tus proyectos' :
                    lang === 'en' ?
                    'Consider mentioning more specific tools used in your projects' :
                    'Considere mencionar mais ferramentas espec√≠ficas usadas em seus projetos');
            }
            
            while (swot.weaknesses.length < 2) {
                swot.weaknesses.push(lang === 'es' ? 'El CV podr√≠a beneficiarse de keywords adicionales del sector objetivo' :
                    lang === 'en' ? 'CV could benefit from additional target sector keywords' :
                    'O CV poderia se beneficiar de palavras-chave adicionais do setor alvo');
            }
            
            // --- OPPORTUNITIES (market-aware) ---
            swot.opportunities.push(lang === 'es' ? 
                `Alta demanda de profesionales senior en ${sectorName} con tu experiencia` :
                lang === 'en' ?
                `High demand for senior professionals in ${sectorName} with your experience` :
                `Alta demanda de profissionais seniores em ${sectorName} com sua experi√™ncia`);
            
            if (extracted.methodologies.includes('Lean') || extracted.methodologies.includes('Agile')) {
                swot.opportunities.push(lang === 'es' ? 
                    'Tu experiencia en metodolog√≠as √°giles/Lean es muy valorada en transformaci√≥n digital' :
                    lang === 'en' ?
                    'Your agile/Lean methodology experience is highly valued in digital transformation' :
                    'Sua experi√™ncia em metodologias √°geis/Lean √© muito valorizada em transforma√ß√£o digital');
            }
            
            swot.opportunities.push(lang === 'es' ? 
                'Tendencia hacia trabajo remoto/h√≠brido ampl√≠a opciones geogr√°ficas' :
                lang === 'en' ?
                'Remote/hybrid work trend expands geographical options' :
                'Tend√™ncia de trabalho remoto/h√≠brido amplia op√ß√µes geogr√°ficas');
            
            swot.opportunities.push(lang === 'es' ? 
                'Posibilidad de posicionarte como thought leader en tu especialidad' :
                lang === 'en' ?
                'Opportunity to position yourself as a thought leader in your specialty' :
                'Possibilidade de se posicionar como thought leader na sua especialidade');
            
            // --- THREATS ---
            swot.threats.push(lang === 'es' ? 
                `Competencia intensa para roles senior en ${sectorName}` :
                lang === 'en' ?
                `Intense competition for senior roles in ${sectorName}` :
                `Competi√ß√£o intensa para fun√ß√µes seniores em ${sectorName}`);
            
            swot.threats.push(lang === 'es' ? 
                'R√°pida evoluci√≥n tecnol√≥gica requiere actualizaci√≥n continua' :
                lang === 'en' ?
                'Rapid technological evolution requires continuous updating' :
                'R√°pida evolu√ß√£o tecnol√≥gica requer atualiza√ß√£o cont√≠nua');
            
            if (level.id === 'lead' || level.id === 'director') {
                swot.threats.push(lang === 'es' ? 
                    'Expectativas salariales senior pueden limitar opciones en startups/scale-ups' :
                    lang === 'en' ?
                    'Senior salary expectations may limit options in startups/scale-ups' :
                    'Expectativas salariais seniores podem limitar op√ß√µes em startups/scale-ups');
            }
            
            return swot;
        }

        function generatePersonalizedRecommendations(metrics, extracted, sector, lang) {
            const recs = [];
            
            // Based on lowest metrics, but personalized
            const sorted = Object.entries(metrics).sort((a, b) => a[1] - b[1]);
            
            sorted.slice(0, 3).forEach(([key, value], idx) => {
                if (value >= 90) return;
                const priority = idx === 0 ? 'high' : idx === 1 ? 'medium' : 'low';
                
                if (key === 'technical' && value < 85) {
                    const missing = sector.keywords.filter(kw => !normalize(state.cv).includes(kw.toLowerCase())).slice(0, 4);
                    recs.push({ priority, 
                        title: lang === 'es' ? 'Optimizar keywords t√©cnicas' : lang === 'en' ? 'Optimize technical keywords' : 'Otimizar palavras-chave t√©cnicas',
                        desc: lang === 'es' ? 
                            `Tu CV se beneficiar√≠a de incluir: ${missing.join(', ')}. A√±√°delas donde tengas experiencia real.` :
                            lang === 'en' ?
                            `Your CV would benefit from including: ${missing.join(', ')}. Add them where you have real experience.` :
                            `Seu CV se beneficiaria de incluir: ${missing.join(', ')}. Adicione-os onde voc√™ tem experi√™ncia real.`
                    });
                }
                
                if (key === 'achievements' && value < 80) {
                    recs.push({ priority,
                        title: lang === 'es' ? 'Cuantificar m√°s logros' : lang === 'en' ? 'Quantify more achievements' : 'Quantificar mais conquistas',
                        desc: lang === 'es' ? 
                            `Ya tienes ${extracted.metrics.length} m√©tricas. Objetivo: a√±adir 2-3 m√°s por rol. Incluye: % de mejora, ‚Ç¨ ahorrados, personas lideradas, plazos cumplidos.` :
                            lang === 'en' ?
                            `You have ${extracted.metrics.length} metrics. Goal: add 2-3 more per role. Include: % improvement, ‚Ç¨ saved, people led, deadlines met.` :
                            `Voc√™ tem ${extracted.metrics.length} m√©tricas. Objetivo: adicionar 2-3 mais por fun√ß√£o. Inclua: % de melhoria, ‚Ç¨ economizados, pessoas lideradas, prazos cumpridos.`
                    });
                }
                
                if (key === 'languages' && value < 75) {
                    recs.push({ priority,
                        title: lang === 'es' ? 'Reforzar perfil de idiomas' : lang === 'en' ? 'Strengthen language profile' : 'Refor√ßar perfil de idiomas',
                        desc: lang === 'es' ? 
                            `${extracted.englishLevel ? 'Tu ingl√©s es ' + extracted.englishLevel + '. ' : ''}Considera certificaci√≥n oficial (Cambridge, IELTS) para validar nivel y acceder a roles internacionales.` :
                            lang === 'en' ?
                            `${extracted.englishLevel ? 'Your English is ' + extracted.englishLevel + '. ' : ''}Consider official certification (Cambridge, IELTS) to validate level and access international roles.` :
                            `${extracted.englishLevel ? 'Seu ingl√™s √© ' + extracted.englishLevel + '. ' : ''}Considere certifica√ß√£o oficial (Cambridge, IELTS) para validar n√≠vel e acessar fun√ß√µes internacionais.`
                    });
                }
                
                if (key === 'leadership' && value < 80 && (state.level === 'lead' || state.level === 'director')) {
                    recs.push({ priority,
                        title: lang === 'es' ? 'Destacar experiencia de liderazgo' : lang === 'en' ? 'Highlight leadership experience' : 'Destacar experi√™ncia de lideran√ßa',
                        desc: lang === 'es' ? 
                            'Para roles senior, enfatiza: tama√±o de equipos gestionados, presupuestos, stakeholders C-level, decisiones estrat√©gicas tomadas.' :
                            lang === 'en' ?
                            'For senior roles, emphasize: team sizes managed, budgets, C-level stakeholders, strategic decisions made.' :
                            'Para fun√ß√µes seniores, enfatize: tamanho de equipes gerenciadas, or√ßamentos, stakeholders C-level, decis√µes estrat√©gicas tomadas.'
                    });
                }
                
                if (key === 'education' && value < 70 && extracted.certifications.length < 2) {
                    recs.push({ priority,
                        title: lang === 'es' ? 'A√±adir certificaciones' : lang === 'en' ? 'Add certifications' : 'Adicionar certifica√ß√µes',
                        desc: lang === 'es' ? 
                            `Para ${sector.label[lang]}, considera: ${sector.keywords.slice(0, 3).map(k => k.toUpperCase()).join(', ')} o certificaciones relacionadas.` :
                            lang === 'en' ?
                            `For ${sector.label[lang]}, consider: ${sector.keywords.slice(0, 3).map(k => k.toUpperCase()).join(', ')} or related certifications.` :
                            `Para ${sector.label[lang]}, considere: ${sector.keywords.slice(0, 3).map(k => k.toUpperCase()).join(', ')} ou certifica√ß√µes relacionadas.`
                    });
                }
            });
            
            // Always add ATS optimization
            recs.push({ priority: 'low',
                title: lang === 'es' ? 'Optimizaci√≥n ATS' : lang === 'en' ? 'ATS Optimization' : 'Otimiza√ß√£o ATS',
                desc: lang === 'es' ? 
                    'Asegura formato limpio (sin tablas complejas, columnas o gr√°ficos). Los ATS leen mejor texto plano con encabezados claros.' :
                    lang === 'en' ?
                    'Ensure clean format (no complex tables, columns or graphics). ATS reads plain text with clear headers better.' :
                    'Garanta formato limpo (sem tabelas complexas, colunas ou gr√°ficos). Os ATS leem melhor texto simples com cabe√ßalhos claros.'
            });
            
            return recs.slice(0, 4);
        }

        function generatePersonalizedSynthesis(score, metrics, extracted, sector, level, lang) {
            const sectorName = sector.label[lang];
            const levelName = level.label[lang].split(' ')[0];
            
            let quality = '';
            if (score >= 90) quality = { es: 'excepcional', en: 'exceptional', pt: 'excepcional' }[lang];
            else if (score >= 82) quality = { es: 'excelente', en: 'excellent', pt: 'excelente' }[lang];
            else if (score >= 75) quality = { es: 'muy s√≥lido', en: 'very strong', pt: 'muito s√≥lido' }[lang];
            else if (score >= 65) quality = { es: 's√≥lido', en: 'solid', pt: 's√≥lido' }[lang];
            else quality = { es: 'competitivo', en: 'competitive', pt: 'competitivo' }[lang];
            
            const strongest = Object.entries(metrics).sort((a, b) => b[1] - a[1])[0][0];
            const weakest = Object.entries(metrics).sort((a, b) => a[1] - b[1])[0][0];
            
            const metricLabels = {
                experience: { es: 'experiencia profesional', en: 'professional experience', pt: 'experi√™ncia profissional' },
                education: { es: 'formaci√≥n acad√©mica', en: 'academic background', pt: 'forma√ß√£o acad√™mica' },
                technical: { es: 'competencias t√©cnicas', en: 'technical skills', pt: 'compet√™ncias t√©cnicas' },
                leadership: { es: 'capacidad de liderazgo', en: 'leadership ability', pt: 'capacidade de lideran√ßa' },
                achievements: { es: 'logros cuantificables', en: 'quantifiable achievements', pt: 'conquistas quantific√°veis' },
                languages: { es: 'perfil de idiomas', en: 'language profile', pt: 'perfil de idiomas' }
            };
            
            const companies = extracted.companies.length ? extracted.companies.slice(0, 3).join(', ') : '';
            const certs = extracted.certifications.length ? extracted.certifications.slice(0, 3).join(', ') : '';
            
            if (lang === 'es') {
                return `Perfil profesional <strong>${quality}</strong> para <strong>${sectorName}</strong> a nivel <strong>${levelName}</strong>. ` +
                    `Con <strong>${extracted.years}+ a√±os de experiencia</strong>${companies ? ' incluyendo ' + companies : ''}, ` +
                    `tu punto m√°s destacado es <strong>${metricLabels[strongest].es}</strong> (${Math.round(metrics[strongest])}%). ` +
                    `${certs ? 'Tus certificaciones (' + certs + ') refuerzan tu perfil t√©cnico. ' : ''}` +
                    `El √°rea con mayor potencial de mejora es <strong>${metricLabels[weakest].es}</strong> (${Math.round(metrics[weakest])}%). ` +
                    `Con una puntuaci√≥n del <strong>${score}%</strong>, ${score >= 75 ? 'est√°s muy bien posicionado para roles senior en el mercado actual.' : 'tienes una base s√≥lida con oportunidades claras de diferenciaci√≥n.'}`;
            } else if (lang === 'en') {
                return `<strong>${quality.charAt(0).toUpperCase() + quality.slice(1)}</strong> professional profile for <strong>${sectorName}</strong> at <strong>${levelName}</strong> level. ` +
                    `With <strong>${extracted.years}+ years of experience</strong>${companies ? ' including ' + companies : ''}, ` +
                    `your strongest point is <strong>${metricLabels[strongest].en}</strong> (${Math.round(metrics[strongest])}%). ` +
                    `${certs ? 'Your certifications (' + certs + ') strengthen your technical profile. ' : ''}` +
                    `The area with most improvement potential is <strong>${metricLabels[weakest].en}</strong> (${Math.round(metrics[weakest])}%). ` +
                    `With a score of <strong>${score}%</strong>, ${score >= 75 ? 'you are very well positioned for senior roles in the current market.' : 'you have a solid foundation with clear differentiation opportunities.'}`;
            } else {
                return `Perfil profissional <strong>${quality}</strong> para <strong>${sectorName}</strong> em n√≠vel <strong>${levelName}</strong>. ` +
                    `Com <strong>${extracted.years}+ anos de experi√™ncia</strong>${companies ? ' incluindo ' + companies : ''}, ` +
                    `seu ponto mais forte √© <strong>${metricLabels[strongest].pt}</strong> (${Math.round(metrics[strongest])}%). ` +
                    `${certs ? 'Suas certifica√ß√µes (' + certs + ') refor√ßam seu perfil t√©cnico. ' : ''}` +
                    `A √°rea com maior potencial de melhoria √© <strong>${metricLabels[weakest].pt}</strong> (${Math.round(metrics[weakest])}%). ` +
                    `Com uma pontua√ß√£o de <strong>${score}%</strong>, ${score >= 75 ? 'voc√™ est√° muito bem posicionado para fun√ß√µes seniores no mercado atual.' : 'voc√™ tem uma base s√≥lida com oportunidades claras de diferencia√ß√£o.'}`;
            }
        }

        // ============================================
        // JOB FIT ANALYSIS
        // ============================================
        function analyzeJobFit(cvText, jobText) {
            const cvNorm = normalize(cvText);
            const jobLower = jobText.toLowerCase();
            const extracted = state.extracted;
            
            // Extract job title
            const titleMatch = jobText.match(/^(.+?)(?:\n|$)/);
            const jobTitle = titleMatch ? titleMatch[1].trim().substring(0, 60) : 'Puesto';
            
            // Extract requirements from job
            const requirements = extractJobRequirements(jobText);
            
            // Match
            const matching = [];
            const gaps = [];
            
            requirements.forEach(req => {
                const reqLower = req.toLowerCase();
                if (cvNorm.includes(reqLower) || checkSynonym(reqLower, cvNorm)) {
                    matching.push(req);
                } else {
                    gaps.push(req);
                }
            });
            
            // Score calculation
            const matchRatio = requirements.length ? matching.length / requirements.length : 0;
            const profileContrib = state.profile.score * 0.35;
            const matchContrib = matchRatio * 50;
            
            // Experience bonus
            const yearsRequired = (jobText.match(/(\d+)\+?\s*(?:years?|a√±os?)/i) || [])[1];
            let expBonus = 10;
            if (yearsRequired && extracted.years >= parseInt(yearsRequired)) expBonus = 15;
            
            const fitScore = Math.min(95, Math.round(profileContrib + matchContrib + expBonus));
            
            // Strategy
            const strategy = generateFitStrategy(matching, gaps, extracted, jobTitle, state.lang);
            
            return { score: fitScore, title: jobTitle, matching, gaps: gaps.slice(0, 8), strategy };
        }

        function extractJobRequirements(jobText) {
            const text = jobText.toLowerCase();
            const reqs = new Set();
            
            // From current sector
            if (state.sector) {
                sectors[state.sector].keywords.forEach(kw => {
                    if (text.includes(kw.toLowerCase())) reqs.add(kw);
                });
            }
            
            // Common requirements
            const common = ['leadership', 'management', 'team', 'strategic', 'analytical', 'communication', 
                'stakeholder', 'agile', 'scrum', 'project management', 'excel', 'english', 'spanish',
                'data-driven', 'process improvement', 'compliance', 'regulatory', 'risk', 'budget',
                'operations', 'customer', 'cross-functional', 'international', 'global'];
            common.forEach(c => { if (text.includes(c)) reqs.add(c); });
            
            return [...reqs].slice(0, 25);
        }

        function checkSynonym(term, cvNorm) {
            const synonyms = {
                'leadership': ['liderazgo', 'l√≠der', 'lead', 'dirigir'],
                'management': ['gesti√≥n', 'manager', 'gerencia'],
                'team': ['equipo', 'team', 'personas'],
                'strategic': ['estrat√©gico', 'estrategia'],
                'analytical': ['anal√≠tico', 'an√°lisis'],
                'operations': ['operaciones', 'operacional'],
                'customer': ['cliente', 'customer service'],
                'global': ['internacional', 'multinacional'],
                'improvement': ['mejora', 'optimizaci√≥n', 'kaizen', 'lean']
            };
            
            for (const [key, syns] of Object.entries(synonyms)) {
                if (term.includes(key) || syns.some(s => term.includes(s))) {
                    if (cvNorm.includes(key) || syns.some(s => cvNorm.includes(s))) return true;
                }
            }
            return false;
        }

        function generateFitStrategy(matching, gaps, extracted, jobTitle, lang) {
            const matchList = matching.slice(0, 4).join(', ');
            const gapList = gaps.slice(0, 3).join(', ');
            
            if (lang === 'es') {
                return `<strong>Para ${jobTitle}:</strong> Tu perfil coincide bien en: ${matchList || 'varios aspectos clave'}. ` +
                    `${gaps.length ? 'Las √°reas a reforzar son: ' + gapList + '. ' : ''}` +
                    `<strong>Estrategia:</strong> En tu carta de presentaci√≥n, vincula directamente tus logros cuantificados ` +
                    `(${extracted.metrics.slice(0, 2).join(', ') || 'tus resultados'}) con los requisitos del puesto. ` +
                    `${extracted.companies.length ? 'Tu experiencia en ' + extracted.companies[0] + ' es especialmente relevante.' : ''}`;
            } else if (lang === 'en') {
                return `<strong>For ${jobTitle}:</strong> Your profile matches well in: ${matchList || 'several key aspects'}. ` +
                    `${gaps.length ? 'Areas to strengthen are: ' + gapList + '. ' : ''}` +
                    `<strong>Strategy:</strong> In your cover letter, directly link your quantified achievements ` +
                    `(${extracted.metrics.slice(0, 2).join(', ') || 'your results'}) with the job requirements. ` +
                    `${extracted.companies.length ? 'Your experience at ' + extracted.companies[0] + ' is especially relevant.' : ''}`;
            } else {
                return `<strong>Para ${jobTitle}:</strong> Seu perfil coincide bem em: ${matchList || 'v√°rios aspectos-chave'}. ` +
                    `${gaps.length ? 'As √°reas a refor√ßar s√£o: ' + gapList + '. ' : ''}` +
                    `<strong>Estrat√©gia:</strong> Na sua carta de apresenta√ß√£o, vincule diretamente suas conquistas quantificadas ` +
                    `(${extracted.metrics.slice(0, 2).join(', ') || 'seus resultados'}) com os requisitos da vaga. ` +
                    `${extracted.companies.length ? 'Sua experi√™ncia em ' + extracted.companies[0] + ' √© especialmente relevante.' : ''}`;
            }
        }

        // ============================================
        // MAIN FUNCTIONS
        // ============================================
        async function runProfileAnalysis() {
            if (!state.sector) { alert(t('error_sector')); return; }
            if (!state.level) { alert(t('error_level')); return; }
            state.cv = document.getElementById('cvInput').value.trim();
            if (state.cv.length < 100) { alert(t('error_cv')); return; }
            
            showLoader(t('loading'));
            await new Promise(r => setTimeout(r, 1200));
            
            state.profile = analyzeProfile(state.cv, state.sector, state.level);
            state.jobFit = null;
            
            hideLoader();
            renderResults();
            showResults();
        }

        async function runJobFitAnalysis() {
            state.job = document.getElementById('jobInput').value.trim();
            if (state.job.length < 50) { alert(t('error_job')); return; }
            
            showLoader(t('loading_fit'));
            await new Promise(r => setTimeout(r, 800));
            
            state.jobFit = analyzeJobFit(state.cv, state.job);
            
            hideLoader();
            renderJobFitResults();
            document.getElementById('jobFitInputCard').classList.add('hidden');
        }

        // ============================================
        // RENDERING
        // ============================================
        function renderResults() {
            const p = state.profile;
            
            // Date
            document.getElementById('resultsDate').textContent = new Date().toLocaleDateString(
                state.lang === 'en' ? 'en-US' : state.lang === 'pt' ? 'pt-BR' : 'es-ES',
                { year: 'numeric', month: 'long', day: 'numeric' }
            );
            
            // Score
            document.getElementById('mainScore').textContent = p.score + '%';
            document.getElementById('scoreLabel').textContent = state.lang === 'es' ? 'Puntuaci√≥n del Perfil' : 
                state.lang === 'en' ? 'Profile Score' : 'Pontua√ß√£o do Perfil';
            
            let interp = '';
            if (p.score >= 90) interp = { es: 'üèÜ Perfil Excepcional', en: 'üèÜ Exceptional Profile', pt: 'üèÜ Perfil Excepcional' }[state.lang];
            else if (p.score >= 82) interp = { es: 'üåü Perfil Excelente', en: 'üåü Excellent Profile', pt: 'üåü Perfil Excelente' }[state.lang];
            else if (p.score >= 75) interp = { es: '‚ú® Perfil Muy S√≥lido', en: '‚ú® Very Strong Profile', pt: '‚ú® Perfil Muito S√≥lido' }[state.lang];
            else if (p.score >= 65) interp = { es: 'üëç Perfil S√≥lido', en: 'üëç Solid Profile', pt: 'üëç Perfil S√≥lido' }[state.lang];
            else interp = { es: 'üìà Perfil Competitivo', en: 'üìà Competitive Profile', pt: 'üìà Perfil Competitivo' }[state.lang];
            document.getElementById('scoreInterpretation').textContent = interp;
            
            // Meta
            document.getElementById('metaSector').textContent = sectors[state.sector].label[state.lang];
            document.getElementById('metaLevel').textContent = levels.find(l => l.id === state.level).label[state.lang].split(' ')[0];
            document.getElementById('metaYears').textContent = state.extracted.years + '+ ' + t('years');
            
            // Gauge
            renderGauge(p.score);
            
            // Synthesis
            document.getElementById('synthesisText').innerHTML = p.synthesis;
            
            // Chart
            renderRadar(p.metrics);
            
            // Metrics bars
            renderMetricBars(p.metrics);
            
            // SWOT
            ['strengths', 'weaknesses', 'opportunities', 'threats'].forEach(key => {
                document.getElementById(key + 'List').innerHTML = p.swot[key].map(item => `<li>${item}</li>`).join('');
            });
            
            // Recommendations
            document.getElementById('recommendationsList').innerHTML = p.recommendations.map((r, i) => `
                <li class="rec-item">
                    <div class="rec-priority ${r.priority}">${i + 1}</div>
                    <div class="rec-content">
                        <div class="rec-title">${r.title}</div>
                        <div class="rec-desc">${r.desc}</div>
                    </div>
                </li>
            `).join('');
            
            // Hide job fit if not done
            document.getElementById('jobFitResults').classList.add('hidden');
        }

        function renderJobFitResults() {
            const jf = state.jobFit;
            const card = document.getElementById('jobFitResults');
            card.classList.remove('hidden');
            
            document.getElementById('jobFitPosition').textContent = jf.title;
            document.getElementById('jobFitScore').textContent = jf.score + '%';
            
            document.getElementById('matchingSkills').innerHTML = jf.matching.map(s => `<span class="tag match">${s}</span>`).join('');
            document.getElementById('gapSkills').innerHTML = jf.gaps.map(s => `<span class="tag gap">${s}</span>`).join('');
            
            document.getElementById('fitStrategy').innerHTML = jf.strategy;
            
            card.scrollIntoView({ behavior: 'smooth' });
        }

        function renderGauge(score) {
            const canvas = document.getElementById('scoreGauge');
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, 200, 200);
            
            // Background
            ctx.beginPath();
            ctx.arc(100, 100, 85, 0.75 * Math.PI, 2.25 * Math.PI);
            ctx.strokeStyle = '#e2e8f0';
            ctx.lineWidth = 14;
            ctx.lineCap = 'round';
            ctx.stroke();
            
            // Score
            ctx.beginPath();
            ctx.arc(100, 100, 85, 0.75 * Math.PI, 0.75 * Math.PI + (score / 100) * 1.5 * Math.PI);
            const grad = ctx.createLinearGradient(0, 0, 200, 200);
            grad.addColorStop(0, '#d4a853');
            grad.addColorStop(1, '#a37633');
            ctx.strokeStyle = grad;
            ctx.lineWidth = 14;
            ctx.lineCap = 'round';
            ctx.stroke();
        }

        function renderRadar(metrics) {
            const ctx = document.getElementById('radarChart').getContext('2d');
            if (state.charts.radar) state.charts.radar.destroy();
            
            const labels = state.lang === 'es' ? 
                ['Experiencia', 'Formaci√≥n', 'T√©cnicas', 'Liderazgo', 'Logros', 'Idiomas'] :
                state.lang === 'en' ?
                ['Experience', 'Education', 'Technical', 'Leadership', 'Achievements', 'Languages'] :
                ['Experi√™ncia', 'Forma√ß√£o', 'T√©cnicas', 'Lideran√ßa', 'Conquistas', 'Idiomas'];
            
            state.charts.radar = new Chart(ctx, {
                type: 'radar',
                data: {
                    labels,
                    datasets: [{
                        data: [metrics.experience, metrics.education, metrics.technical, metrics.leadership, metrics.achievements, metrics.languages],
                        backgroundColor: 'rgba(212, 168, 83, 0.2)',
                        borderColor: '#d4a853',
                        borderWidth: 2,
                        pointBackgroundColor: '#d4a853'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: { r: { beginAtZero: true, max: 100, ticks: { stepSize: 25, font: { size: 10 } }, pointLabels: { font: { size: 11 } } } }
                }
            });
        }

        function renderMetricBars(metrics) {
            const labels = state.lang === 'es' ? 
                { experience: 'Experiencia', education: 'Formaci√≥n', technical: 'Skills T√©cnicas', leadership: 'Liderazgo', achievements: 'Logros', languages: 'Idiomas' } :
                state.lang === 'en' ?
                { experience: 'Experience', education: 'Education', technical: 'Technical Skills', leadership: 'Leadership', achievements: 'Achievements', languages: 'Languages' } :
                { experience: 'Experi√™ncia', education: 'Forma√ß√£o', technical: 'Skills T√©cnicas', leadership: 'Lideran√ßa', achievements: 'Conquistas', languages: 'Idiomas' };
            
            const colors = { experience: '#d4a853', education: '#a37633', technical: '#059669', leadership: '#7c3aed', achievements: '#0284c7', languages: '#db2777' };
            
            document.getElementById('metricsContainer').innerHTML = Object.entries(metrics).map(([k, v]) => `
                <div class="metric-item">
                    <span class="metric-label">${labels[k]}</span>
                    <div class="metric-bar"><div class="metric-fill" style="width: ${v}%; background: ${colors[k]};"></div></div>
                    <span class="metric-value">${Math.round(v)}%</span>
                </div>
            `).join('');
        }

        // ============================================
        // PDF
        // ============================================
        async function generatePDF() {
            showLoader('Generando PDF...');
            
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF('p', 'mm', 'a4');
            
            document.body.dataset.theme = '';
            await new Promise(r => setTimeout(r, 100));
            
            const sections = ['resultsHeader', 'synthesisCard', 'competenciesCard', 'swotCard', 'recommendationsCard'];
            if (!document.getElementById('jobFitResults').classList.contains('hidden')) sections.push('jobFitResults');
            sections.push('resultsFooter');
            
            let y = 10, page = 1;
            
            for (const id of sections) {
                const el = document.getElementById(id);
                if (!el) continue;
                
                try {
                    const canvas = await html2canvas(el, { scale: 2, backgroundColor: '#fefdfb', logging: false });
                    const imgW = 190, imgH = canvas.height * imgW / canvas.width;
                    
                    if (y + imgH > 287) {
                        pdf.setFontSize(8); pdf.setTextColor(150); pdf.text(`${page}`, 105, 292, { align: 'center' });
                        pdf.addPage(); page++; y = 10;
                    }
                    
                    pdf.addImage(canvas.toDataURL('image/png'), 'PNG', 10, y, imgW, imgH);
                    y += imgH + 5;
                } catch (e) { console.error(e); }
            }
            
            pdf.setFontSize(8); pdf.setTextColor(150); pdf.text(`${page}`, 105, 292, { align: 'center' });
            pdf.save(`RV_Profile_${new Date().toISOString().split('T')[0]}.pdf`);
            
            hideLoader();
        }

        function contact() {
            const subject = encodeURIComponent('Consulta - RV Profile Studio');
            const body = encodeURIComponent(`Hola,\n\nHe analizado mi perfil y obtuve ${state.profile?.score || '-'}%.\n\nMe gustar√≠a solicitar asesoramiento.\n\nSaludos.`);
            window.open(`mailto:${CONFIG.email}?subject=${subject}&body=${body}`);
        }

        // ============================================
        // INIT
        // ============================================
        document.addEventListener('DOMContentLoaded', () => {
            renderSectors();
            renderLevels();
            document.getElementById('cvInput').addEventListener('input', updateCharCount);
            if (window.matchMedia?.('(prefers-color-scheme: dark)').matches) {
                document.body.dataset.theme = 'dark';
                document.getElementById('themeIcon').textContent = '‚òÄÔ∏è';
            }
            console.log('RV Profile Studio v' + CONFIG.version);
        });
    </script>
</body>
</html>
