<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RV Profile Studio | Career Intelligence & Professional Analysis</title>
    <meta name="description" content="AI-powered career consulting: CV analysis, SWOT reports, and job fit assessment in 3 languages.">
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@400;500;600;700&family=DM+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <style>
        :root {
            --gold-50: #fefdfb;
            --gold-100: #fdf9f0;
            --gold-200: #f9f0db;
            --gold-300: #f0ddb3;
            --gold-400: #e4c378;
            --gold-500: #d4a853;
            --gold-600: #c4943f;
            --gold-700: #a37633;
            --gold-800: #865f2d;
            --gold-900: #6e4e27;
            
            --slate-50: #f8fafc;
            --slate-100: #f1f5f9;
            --slate-200: #e2e8f0;
            --slate-300: #cbd5e1;
            --slate-400: #94a3b8;
            --slate-500: #64748b;
            --slate-600: #475569;
            --slate-700: #334155;
            --slate-800: #1e293b;
            --slate-900: #0f172a;
            
            --bg-primary: var(--gold-50);
            --bg-card: #ffffff;
            --text-primary: var(--slate-900);
            --text-secondary: var(--slate-600);
            --text-muted: var(--slate-400);
            --brand: var(--gold-600);
            --brand-dark: var(--gold-700);
            --brand-light: var(--gold-200);
            
            --success: #059669;
            --success-bg: #ecfdf5;
            --warning: #d97706;
            --warning-bg: #fffbeb;
            --danger: #dc2626;
            --danger-bg: #fef2f2;
            --info: #0284c7;
            --info-bg: #f0f9ff;
            
            --font-display: 'Cormorant Garamond', Georgia, serif;
            --font-body: 'DM Sans', -apple-system, BlinkMacSystemFont, sans-serif;
            
            --space-xs: 4px;
            --space-sm: 8px;
            --space-md: 16px;
            --space-lg: 24px;
            --space-xl: 32px;
            --space-2xl: 48px;
            
            --radius-sm: 6px;
            --radius-md: 12px;
            --radius-lg: 20px;
            --shadow-md: 0 4px 12px rgba(0,0,0,0.06);
            --shadow-lg: 0 12px 40px rgba(0,0,0,0.08);
            --transition: 0.25s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        [data-theme="dark"] {
            --bg-primary: #0c0c0c;
            --bg-card: #161616;
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --text-muted: #64748b;
            --brand-light: rgba(212, 168, 83, 0.15);
            --shadow-md: 0 4px 12px rgba(0,0,0,0.3);
            --success-bg: rgba(5, 150, 105, 0.15);
            --warning-bg: rgba(217, 119, 6, 0.15);
            --danger-bg: rgba(220, 38, 38, 0.15);
            --info-bg: rgba(2, 132, 199, 0.15);
        }
        
        *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }
        html { scroll-behavior: smooth; }
        
        body {
            font-family: var(--font-body);
            font-size: 16px;
            line-height: 1.7;
            color: var(--text-primary);
            background: var(--bg-primary);
            min-height: 100vh;
            transition: background var(--transition), color var(--transition);
        }
        
        h1, h2, h3, h4, h5, h6 {
            font-family: var(--font-display);
            font-weight: 600;
            line-height: 1.3;
        }
        
        ::selection { background: var(--brand); color: white; }
        
        .app-wrapper { max-width: 1100px; margin: 0 auto; padding: var(--space-lg); }
        @media (min-width: 768px) { .app-wrapper { padding: var(--space-2xl); } }
        
        /* Header */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--space-lg) 0;
            margin-bottom: var(--space-2xl);
            border-bottom: 1px solid var(--brand-light);
        }
        
        .logo { display: flex; align-items: baseline; gap: var(--space-xs); }
        .logo-mark { font-family: var(--font-display); font-size: 2.2rem; font-weight: 700; color: var(--brand); }
        .logo-text { font-family: var(--font-display); font-size: 1.4rem; color: var(--text-primary); letter-spacing: 1px; }
        
        .header-controls { display: flex; align-items: center; gap: var(--space-md); }
        
        .lang-select {
            font-family: var(--font-body);
            font-size: 0.875rem;
            font-weight: 500;
            padding: var(--space-sm) var(--space-md);
            border: 1px solid var(--text-muted);
            border-radius: var(--radius-sm);
            background: transparent;
            color: var(--text-primary);
            cursor: pointer;
        }
        
        .theme-toggle {
            width: 40px; height: 40px;
            border: 1px solid var(--text-muted);
            border-radius: var(--radius-sm);
            background: transparent;
            color: var(--text-primary);
            cursor: pointer;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        /* Stepper */
        .stepper {
            display: flex;
            justify-content: center;
            gap: var(--space-xl);
            margin-bottom: var(--space-2xl);
            flex-wrap: wrap;
        }
        
        .step {
            display: flex;
            align-items: center;
            gap: var(--space-sm);
            padding: var(--space-sm) var(--space-md);
            border-radius: var(--radius-md);
            cursor: pointer;
            opacity: 0.5;
            transition: all var(--transition);
        }
        
        .step:hover { opacity: 0.8; }
        .step.active { opacity: 1; background: var(--brand-light); }
        .step.completed { opacity: 1; }
        
        .step-number {
            width: 32px; height: 32px;
            border: 2px solid currentColor;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 0.875rem;
        }
        
        .step.active .step-number { background: var(--brand); border-color: var(--brand); color: white; }
        .step.completed .step-number { background: var(--success); border-color: var(--success); color: white; }
        .step-label { font-weight: 500; font-size: 0.95rem; }
        
        /* Panels */
        .panel { display: none; animation: panelFadeIn 0.4s ease; }
        .panel.active { display: block; }
        @keyframes panelFadeIn { from { opacity: 0; transform: translateY(12px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Cards */
        .card {
            background: var(--bg-card);
            border-radius: var(--radius-lg);
            padding: var(--space-xl);
            margin-bottom: var(--space-lg);
            box-shadow: var(--shadow-md);
            border: 1px solid rgba(0,0,0,0.04);
        }
        
        [data-theme="dark"] .card { border-color: rgba(255,255,255,0.05); }
        
        .card-title {
            font-size: 1.35rem;
            margin-bottom: var(--space-xs);
            display: flex;
            align-items: center;
            gap: var(--space-sm);
        }
        
        .card-subtitle { font-size: 0.9rem; color: var(--text-secondary); margin-bottom: var(--space-lg); }
        
        /* Form Elements */
        .form-group { margin-bottom: var(--space-lg); }
        .form-label { display: block; font-weight: 500; font-size: 0.9rem; margin-bottom: var(--space-sm); }
        
        .form-input, .form-textarea, .form-select {
            width: 100%;
            padding: var(--space-md);
            font-family: var(--font-body);
            font-size: 1rem;
            color: var(--text-primary);
            background: var(--bg-primary);
            border: 1px solid var(--slate-300);
            border-radius: var(--radius-md);
            transition: all var(--transition);
        }
        
        [data-theme="dark"] .form-input,
        [data-theme="dark"] .form-textarea { border-color: var(--slate-700); }
        
        .form-input:focus, .form-textarea:focus {
            outline: none;
            border-color: var(--brand);
            box-shadow: 0 0 0 3px var(--brand-light);
        }
        
        .form-textarea { min-height: 220px; resize: vertical; line-height: 1.6; }
        .form-hint { font-size: 0.8rem; color: var(--text-muted); margin-top: var(--space-xs); }
        
        /* Option Grid - Improved for more sectors */
        .option-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
            gap: var(--space-sm);
        }
        
        .option-pill {
            padding: var(--space-md);
            border: 1px solid var(--slate-300);
            border-radius: var(--radius-md);
            text-align: center;
            font-size: 0.85rem;
            font-weight: 500;
            cursor: pointer;
            transition: all var(--transition);
            background: var(--bg-card);
        }
        
        [data-theme="dark"] .option-pill { border-color: var(--slate-700); }
        .option-pill:hover { border-color: var(--brand); color: var(--brand); }
        .option-pill.selected { background: var(--brand); border-color: var(--brand); color: white; }
        
        /* Buttons */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: var(--space-sm);
            padding: var(--space-md) var(--space-xl);
            font-family: var(--font-body);
            font-size: 1rem;
            font-weight: 600;
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: all var(--transition);
            border: none;
        }
        
        .btn-primary { background: var(--brand); color: white; width: 100%; }
        .btn-primary:hover { background: var(--brand-dark); transform: translateY(-2px); }
        .btn-primary:disabled { background: var(--text-muted); cursor: not-allowed; transform: none; }
        
        .btn-secondary { background: transparent; border: 2px solid var(--brand); color: var(--brand); }
        .btn-secondary:hover { background: var(--brand-light); }
        
        .btn-ghost { background: transparent; color: var(--text-secondary); padding: var(--space-sm) var(--space-md); }
        .btn-ghost:hover { color: var(--brand); background: var(--brand-light); }
        
        .btn-group { display: flex; gap: var(--space-md); margin-top: var(--space-lg); }
        .btn-group .btn { flex: 1; }
        
        /* Analysis Mode Selection - NEW */
        .analysis-mode-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--space-lg);
            margin-bottom: var(--space-lg);
        }
        
        @media (max-width: 600px) {
            .analysis-mode-grid { grid-template-columns: 1fr; }
        }
        
        .analysis-mode-card {
            padding: var(--space-xl);
            border: 2px solid var(--slate-200);
            border-radius: var(--radius-lg);
            cursor: pointer;
            transition: all var(--transition);
            text-align: center;
        }
        
        [data-theme="dark"] .analysis-mode-card { border-color: var(--slate-700); }
        
        .analysis-mode-card:hover {
            border-color: var(--brand);
            transform: translateY(-2px);
        }
        
        .analysis-mode-card.selected {
            border-color: var(--brand);
            background: var(--brand-light);
        }
        
        .analysis-mode-icon { font-size: 2.5rem; margin-bottom: var(--space-md); }
        .analysis-mode-title { font-size: 1.1rem; font-weight: 600; margin-bottom: var(--space-sm); }
        .analysis-mode-desc { font-size: 0.85rem; color: var(--text-secondary); }
        
        /* Results Section */
        .results-header {
            text-align: center;
            padding: var(--space-2xl) var(--space-lg);
            background: var(--bg-card);
            border-radius: var(--radius-lg);
            margin-bottom: var(--space-lg);
        }
        
        .results-brand { margin-bottom: var(--space-lg); }
        .results-date { font-size: 0.85rem; color: var(--text-muted); margin-bottom: var(--space-md); }
        
        .score-circle { position: relative; width: 200px; height: 200px; margin: 0 auto var(--space-lg); }
        .score-canvas { position: absolute; top: 0; left: 0; }
        .score-value {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-family: var(--font-display);
            font-size: 3.5rem;
            font-weight: 700;
            color: var(--brand);
        }
        
        .score-label { font-size: 1.1rem; color: var(--text-secondary); margin-bottom: var(--space-md); }
        
        .score-interpretation {
            display: inline-block;
            padding: var(--space-sm) var(--space-lg);
            background: var(--brand-light);
            border-radius: var(--radius-lg);
            font-weight: 600;
            color: var(--brand-dark);
        }
        
        .profile-meta {
            display: flex;
            justify-content: center;
            gap: var(--space-xl);
            margin-top: var(--space-lg);
            padding-top: var(--space-lg);
            border-top: 1px solid var(--slate-200);
            flex-wrap: wrap;
        }
        
        .meta-item { text-align: center; }
        .meta-label { font-size: 0.75rem; text-transform: uppercase; letter-spacing: 1px; color: var(--text-muted); margin-bottom: var(--space-xs); }
        .meta-value { font-weight: 600; color: var(--text-primary); }
        
        /* Dashboard Grid */
        .dashboard-grid { display: grid; gap: var(--space-lg); }
        @media (min-width: 768px) { .dashboard-grid { grid-template-columns: 1fr 1fr; } }
        
        /* Metric Bars */
        .metric-item { display: flex; align-items: center; gap: var(--space-md); margin-bottom: var(--space-md); }
        .metric-label { width: 140px; font-size: 0.85rem; font-weight: 500; flex-shrink: 0; }
        .metric-bar { flex-grow: 1; height: 12px; background: var(--slate-200); border-radius: 6px; overflow: hidden; }
        [data-theme="dark"] .metric-bar { background: var(--slate-700); }
        .metric-fill { height: 100%; border-radius: 6px; transition: width 1s ease; }
        .metric-value { width: 50px; text-align: right; font-weight: 600; font-size: 0.9rem; }
        
        /* SWOT Grid */
        .swot-grid { display: grid; grid-template-columns: 1fr 1fr; gap: var(--space-md); }
        @media (max-width: 600px) { .swot-grid { grid-template-columns: 1fr; } }
        
        .swot-card { padding: var(--space-lg); border-radius: var(--radius-md); }
        .swot-strengths { background: var(--success-bg); border-left: 4px solid var(--success); }
        .swot-weaknesses { background: var(--danger-bg); border-left: 4px solid var(--danger); }
        .swot-opportunities { background: var(--info-bg); border-left: 4px solid var(--info); }
        .swot-threats { background: var(--warning-bg); border-left: 4px solid var(--warning); }
        
        .swot-title { font-size: 1rem; font-weight: 600; margin-bottom: var(--space-md); display: flex; align-items: center; gap: var(--space-sm); }
        .swot-list { list-style: none; }
        .swot-list li { position: relative; padding-left: var(--space-lg); margin-bottom: var(--space-sm); font-size: 0.9rem; line-height: 1.5; }
        .swot-list li::before { content: ''; position: absolute; left: 0; top: 8px; width: 6px; height: 6px; border-radius: 50%; background: currentColor; }
        
        /* Recommendations */
        .rec-list { list-style: none; }
        .rec-item { display: flex; gap: var(--space-md); padding: var(--space-md); background: var(--bg-primary); border-radius: var(--radius-md); margin-bottom: var(--space-sm); }
        .rec-priority { width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 0.8rem; flex-shrink: 0; }
        .rec-priority.high { background: var(--danger); color: white; }
        .rec-priority.medium { background: var(--warning); color: white; }
        .rec-priority.low { background: var(--success); color: white; }
        .rec-content { flex-grow: 1; }
        .rec-title { font-weight: 600; font-size: 0.95rem; margin-bottom: 2px; }
        .rec-desc { font-size: 0.85rem; color: var(--text-secondary); }
        
        /* Tags */
        .tag-list { display: flex; flex-wrap: wrap; gap: var(--space-sm); }
        .tag { padding: var(--space-xs) var(--space-md); border-radius: var(--radius-lg); font-size: 0.8rem; font-weight: 500; }
        .tag.match { background: var(--success-bg); color: var(--success); }
        .tag.missing { background: var(--danger-bg); color: var(--danger); }
        
        /* Synthesis */
        .synthesis-text { font-size: 1rem; line-height: 1.8; color: var(--text-secondary); }
        
        /* Chart Container */
        .chart-container { position: relative; height: 300px; margin-bottom: var(--space-lg); }
        
        /* CTA Card */
        .cta-card { background: linear-gradient(135deg, var(--brand) 0%, var(--brand-dark) 100%); color: white; text-align: center; }
        .cta-card .card-title { color: white; justify-content: center; }
        .cta-card p { opacity: 0.9; margin-bottom: var(--space-lg); }
        .cta-card .btn { background: white; color: var(--brand-dark); }
        
        /* Job Fit */
        .fit-comparison { display: grid; gap: var(--space-lg); }
        @media (min-width: 768px) { .fit-comparison { grid-template-columns: 1fr 1fr; } }
        .fit-section-title { font-size: 0.9rem; font-weight: 600; text-transform: uppercase; letter-spacing: 1px; color: var(--text-muted); margin-bottom: var(--space-md); }
        
        /* Loading */
        .loader-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.95); z-index: 9999;
            display: none; justify-content: center; align-items: center; flex-direction: column;
        }
        [data-theme="dark"] .loader-overlay { background: rgba(0,0,0,0.95); }
        .loader-overlay.active { display: flex; }
        .spinner { width: 56px; height: 56px; border: 4px solid var(--brand-light); border-top-color: var(--brand); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .loader-text { margin-top: var(--space-lg); font-size: 1.1rem; color: var(--text-secondary); }
        
        /* Utilities */
        .text-center { text-align: center; }
        .text-success { color: var(--success); }
        .text-warning { color: var(--warning); }
        .text-danger { color: var(--danger); }
        .mt-lg { margin-top: var(--space-lg); }
        .mb-lg { margin-bottom: var(--space-lg); }
        .hidden { display: none !important; }
        
        /* PDF */
        .pdf-actions { display: flex; justify-content: center; gap: var(--space-md); margin-bottom: var(--space-xl); flex-wrap: wrap; }
        .results-footer { text-align: center; padding: var(--space-lg); margin-top: var(--space-lg); border-top: 1px solid var(--slate-200); font-size: 0.85rem; color: var(--text-muted); }
        .results-footer a { color: var(--brand); }
        
        /* Print */
        @media print {
            body { background: white !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
            .header-controls, .stepper, .pdf-actions, .cta-card, #panel1, #panel2 { display: none !important; }
            .card { box-shadow: none !important; break-inside: avoid; }
        }
        
        /* Responsive */
        @media (max-width: 600px) {
            .header { flex-direction: column; gap: var(--space-md); text-align: center; }
            .stepper { gap: var(--space-sm); }
            .step-label { display: none; }
            .card { padding: var(--space-lg); }
            .score-value { font-size: 2.5rem; }
            .btn-group { flex-direction: column; }
        }
    </style>
</head>
<body>
    <div class="loader-overlay" id="loader">
        <div class="spinner"></div>
        <p class="loader-text" id="loaderText">Analizando perfil profesional...</p>
    </div>

    <div class="app-wrapper">
        <header class="header">
            <div class="logo">
                <span class="logo-mark">RV</span>
                <span class="logo-text">Profile Studio</span>
            </div>
            <div class="header-controls">
                <select class="lang-select" id="langSelect" onchange="changeLang(this.value)">
                    <option value="es">Espa√±ol</option>
                    <option value="en">English</option>
                    <option value="pt">Portugu√™s</option>
                </select>
                <button class="theme-toggle" onclick="toggleTheme()" aria-label="Toggle theme">
                    <span id="themeIcon">üåô</span>
                </button>
            </div>
        </header>

        <nav class="stepper">
            <div class="step active" data-step="1" onclick="goToStep(1)">
                <div class="step-number">1</div>
                <span class="step-label" data-i18n="step_profile">Perfil</span>
            </div>
            <div class="step" data-step="2" onclick="goToStep(2)">
                <div class="step-number">2</div>
                <span class="step-label" data-i18n="step_analysis">An√°lisis</span>
            </div>
            <div class="step" data-step="3" onclick="goToStep(3)">
                <div class="step-number">3</div>
                <span class="step-label" data-i18n="step_results">Resultados</span>
            </div>
        </nav>

        <!-- Panel 1: Profile Input -->
        <section class="panel active" id="panel1">
            <div class="card">
                <h2 class="card-title">üéØ <span data-i18n="sector_title">Sector Profesional</span></h2>
                <p class="card-subtitle" data-i18n="sector_subtitle">Selecciona tu √°rea de especializaci√≥n principal</p>
                <div class="option-grid" id="sectorGrid"></div>
            </div>

            <div class="card">
                <h2 class="card-title">üìä <span data-i18n="level_title">Nivel de Experiencia</span></h2>
                <p class="card-subtitle" data-i18n="level_subtitle">A√±os de experiencia profesional total</p>
                <div class="option-grid" id="levelGrid"></div>
            </div>

            <div class="card">
                <h2 class="card-title">üìÑ <span data-i18n="cv_title">Tu Curr√≠culum</span></h2>
                <p class="card-subtitle" data-i18n="cv_subtitle">Copia y pega el contenido completo de tu CV</p>
                <div class="form-group">
                    <textarea class="form-textarea" id="cvInput" placeholder="Pega aqu√≠ el texto de tu curr√≠culum..." data-i18n-placeholder="cv_placeholder"></textarea>
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-top: var(--space-sm);">
                        <button class="btn-ghost" onclick="loadExampleCV()" data-i18n="load_example">Cargar ejemplo</button>
                        <span class="form-hint" id="charCount">0 caracteres</span>
                    </div>
                </div>
            </div>

            <button class="btn btn-primary" onclick="goToStep(2)">
                <span data-i18n="continue_btn">Continuar</span>
                <span>‚Üí</span>
            </button>
        </section>

        <!-- Panel 2: Analysis Type Selection -->
        <section class="panel" id="panel2">
            <div class="card">
                <h2 class="card-title">üìã <span data-i18n="analysis_type_title">Tipo de An√°lisis</span></h2>
                <p class="card-subtitle" data-i18n="analysis_type_subtitle">Selecciona qu√© tipo de an√°lisis deseas realizar</p>
                
                <div class="analysis-mode-grid">
                    <div class="analysis-mode-card" id="modeProfile" onclick="selectAnalysisMode('profile')">
                        <div class="analysis-mode-icon">üìä</div>
                        <div class="analysis-mode-title" data-i18n="mode_profile_title">An√°lisis de Perfil</div>
                        <div class="analysis-mode-desc" data-i18n="mode_profile_desc">Evaluaci√≥n completa de tu CV con DAFO y recomendaciones de mejora</div>
                    </div>
                    <div class="analysis-mode-card" id="modeJobFit" onclick="selectAnalysisMode('jobfit')">
                        <div class="analysis-mode-icon">üéØ</div>
                        <div class="analysis-mode-title" data-i18n="mode_jobfit_title">Perfil + Compatibilidad</div>
                        <div class="analysis-mode-desc" data-i18n="mode_jobfit_desc">An√°lisis de perfil m√°s comparaci√≥n con una oferta de trabajo espec√≠fica</div>
                    </div>
                </div>
            </div>

            <!-- Job Description (shown when jobfit mode selected) -->
            <div class="card hidden" id="jobDescriptionCard">
                <h2 class="card-title">üíº <span data-i18n="job_title">Descripci√≥n del Puesto</span></h2>
                <p class="card-subtitle" data-i18n="job_subtitle">Pega la descripci√≥n completa de la oferta de trabajo</p>
                <div class="form-group">
                    <textarea class="form-textarea" id="jobInput" placeholder="Copia aqu√≠ los requisitos y descripci√≥n del puesto..." data-i18n-placeholder="job_placeholder"></textarea>
                </div>
            </div>

            <div class="btn-group">
                <button class="btn btn-secondary" onclick="goToStep(1)">
                    <span>‚Üê</span>
                    <span data-i18n="back_btn">Atr√°s</span>
                </button>
                <button class="btn btn-primary" onclick="runAnalysis()" id="runAnalysisBtn" disabled>
                    <span data-i18n="analyze_btn">Analizar</span>
                    <span>‚Üí</span>
                </button>
            </div>
        </section>

        <!-- Panel 3: Results -->
        <section class="panel" id="panel3">
            <div class="pdf-actions">
                <button class="btn btn-secondary" onclick="generatePDF()">
                    üì• <span data-i18n="download_pdf">Descargar Informe PDF</span>
                </button>
                <button class="btn btn-ghost" onclick="window.print()">
                    üñ®Ô∏è <span data-i18n="print_report">Imprimir</span>
                </button>
            </div>

            <div id="resultsContent">
                <div class="results-header" id="resultsHeader">
                    <div class="results-brand">
                        <div class="logo" style="justify-content: center;">
                            <span class="logo-mark">RV</span>
                            <span class="logo-text">Profile Studio</span>
                        </div>
                    </div>
                    <p class="results-date" id="resultsDate"></p>
                    
                    <div class="score-circle">
                        <canvas id="scoreGauge" class="score-canvas" width="200" height="200"></canvas>
                        <div class="score-value" id="mainScore">0%</div>
                    </div>
                    <p class="score-label" id="scoreLabel">Puntuaci√≥n General del Perfil</p>
                    <span class="score-interpretation" id="scoreInterpretation">Calculando...</span>
                    
                    <div class="profile-meta">
                        <div class="meta-item">
                            <p class="meta-label" data-i18n="sector_title">Sector</p>
                            <p class="meta-value" id="metaSector">-</p>
                        </div>
                        <div class="meta-item">
                            <p class="meta-label" data-i18n="level_title">Nivel</p>
                            <p class="meta-value" id="metaLevel">-</p>
                        </div>
                        <div class="meta-item">
                            <p class="meta-label" data-i18n="meta_experience">Experiencia</p>
                            <p class="meta-value" id="metaYears">-</p>
                        </div>
                    </div>
                </div>

                <div class="dashboard-grid">
                    <div>
                        <div class="card" id="competenciesCard">
                            <h3 class="card-title" data-i18n="competencies_title">Competencias Profesionales</h3>
                            <div class="chart-container">
                                <canvas id="radarChart"></canvas>
                            </div>
                            <div id="metricsContainer"></div>
                        </div>

                        <div class="card" id="synthesisCard">
                            <h3 class="card-title" data-i18n="synthesis_title">S√≠ntesis Ejecutiva</h3>
                            <p class="synthesis-text" id="synthesisText">Esperando an√°lisis...</p>
                        </div>
                    </div>

                    <div>
                        <div class="card" id="swotCard">
                            <h3 class="card-title mb-lg" data-i18n="swot_title">An√°lisis DAFO</h3>
                            <div class="swot-grid">
                                <div class="swot-card swot-strengths">
                                    <div class="swot-title text-success">üí™ <span data-i18n="strengths">Fortalezas</span></div>
                                    <ul class="swot-list" id="strengthsList"></ul>
                                </div>
                                <div class="swot-card swot-weaknesses">
                                    <div class="swot-title text-danger">‚ö†Ô∏è <span data-i18n="weaknesses">Debilidades</span></div>
                                    <ul class="swot-list" id="weaknessesList"></ul>
                                </div>
                                <div class="swot-card swot-opportunities">
                                    <div class="swot-title" style="color: var(--info);">üöÄ <span data-i18n="opportunities">Oportunidades</span></div>
                                    <ul class="swot-list" id="opportunitiesList"></ul>
                                </div>
                                <div class="swot-card swot-threats">
                                    <div class="swot-title text-warning">üîç <span data-i18n="threats">Amenazas</span></div>
                                    <ul class="swot-list" id="threatsList"></ul>
                                </div>
                            </div>
                        </div>

                        <div class="card" id="recommendationsCard">
                            <h3 class="card-title" data-i18n="recommendations_title">Plan de Acci√≥n</h3>
                            <ul class="rec-list" id="recommendationsList"></ul>
                        </div>
                    </div>
                </div>

                <div class="card hidden" id="jobFitResults">
                    <h3 class="card-title mb-lg">üéØ <span data-i18n="jobfit_results_title">An√°lisis de Compatibilidad con el Puesto</span></h3>
                    
                    <div class="fit-comparison">
                        <div>
                            <p class="fit-section-title" data-i18n="matching_skills">Competencias Coincidentes</p>
                            <div class="tag-list" id="matchingSkills"></div>
                        </div>
                        <div>
                            <p class="fit-section-title" data-i18n="gap_skills">√Åreas de Desarrollo</p>
                            <div class="tag-list" id="gapSkills"></div>
                        </div>
                    </div>
                    
                    <div class="mt-lg">
                        <h4 class="card-title" style="font-size: 1.1rem;" data-i18n="fit_recommendations">Recomendaciones para este Puesto</h4>
                        <p class="synthesis-text" id="fitRecommendationsText"></p>
                    </div>
                </div>

                <div class="results-footer" id="resultsFooter">
                    <p>Generado con <strong>RV Profile Studio</strong> | <a href="mailto:rvprofilestudio@gmail.com">rvprofilestudio@gmail.com</a></p>
                    <p style="margin-top: 5px; font-size: 0.75rem;">Este informe es una evaluaci√≥n automatizada. Para un an√°lisis m√°s profundo, contacte con nuestro equipo.</p>
                </div>
            </div>

            <div class="card cta-card" style="margin-top: var(--space-lg);">
                <h3 class="card-title" data-i18n="cta_title">¬øNecesitas asesoramiento experto?</h3>
                <p data-i18n="cta_text">Solicita una sesi√≥n estrat√©gica de 1 hora para revisar estos resultados en profundidad.</p>
                <button class="btn" onclick="contactConsultant()">üìß <span data-i18n="cta_btn">Contactar Consultor</span></button>
            </div>

            <button class="btn btn-secondary" onclick="resetApp()" style="width: 100%; margin-top: var(--space-lg);">
                üîÑ <span data-i18n="new_analysis">Nuevo An√°lisis</span>
            </button>
        </section>
    </div>

    <script>
        // ============================================
        // RV PROFILE STUDIO v3.0 - ENHANCED ENGINE
        // ============================================

        const CONFIG = {
            consultantEmail: 'rvprofilestudio@gmail.com',
            version: '3.0.0'
        };

        let state = {
            lang: 'es',
            sector: null,
            level: null,
            cv: '',
            job: '',
            analysisMode: null, // 'profile' or 'jobfit'
            profileResults: null,
            jobFitResults: null,
            currentStep: 1,
            charts: {}
        };

        // --- i18n ---
        const translations = {
            es: {
                step_profile: 'Perfil', step_analysis: 'An√°lisis', step_results: 'Resultados',
                sector_title: 'Sector Profesional', sector_subtitle: 'Selecciona tu √°rea de especializaci√≥n principal',
                level_title: 'Nivel de Experiencia', level_subtitle: 'A√±os de experiencia profesional total',
                cv_title: 'Tu Curr√≠culum', cv_subtitle: 'Copia y pega el contenido completo de tu CV',
                cv_placeholder: 'Pega aqu√≠ el texto de tu curr√≠culum...',
                load_example: 'Cargar ejemplo', continue_btn: 'Continuar',
                analysis_type_title: 'Tipo de An√°lisis', analysis_type_subtitle: 'Selecciona qu√© tipo de an√°lisis deseas realizar',
                mode_profile_title: 'An√°lisis de Perfil', mode_profile_desc: 'Evaluaci√≥n completa de tu CV con DAFO y recomendaciones de mejora',
                mode_jobfit_title: 'Perfil + Compatibilidad', mode_jobfit_desc: 'An√°lisis de perfil m√°s comparaci√≥n con una oferta de trabajo espec√≠fica',
                job_title: 'Descripci√≥n del Puesto', job_subtitle: 'Pega la descripci√≥n completa de la oferta de trabajo',
                job_placeholder: 'Copia aqu√≠ los requisitos y descripci√≥n del puesto...',
                back_btn: 'Atr√°s', analyze_btn: 'Analizar',
                download_pdf: 'Descargar Informe PDF', print_report: 'Imprimir',
                competencies_title: 'Competencias Profesionales', synthesis_title: 'S√≠ntesis Ejecutiva',
                swot_title: 'An√°lisis DAFO', strengths: 'Fortalezas', weaknesses: 'Debilidades',
                opportunities: 'Oportunidades', threats: 'Amenazas', recommendations_title: 'Plan de Acci√≥n',
                jobfit_results_title: 'An√°lisis de Compatibilidad con el Puesto',
                matching_skills: 'Competencias Coincidentes', gap_skills: '√Åreas de Desarrollo',
                fit_recommendations: 'Recomendaciones para este Puesto',
                cta_title: '¬øNecesitas asesoramiento experto?',
                cta_text: 'Solicita una sesi√≥n estrat√©gica de 1 hora para revisar estos resultados.',
                cta_btn: 'Contactar Consultor', new_analysis: 'Nuevo An√°lisis',
                
                // Sectors - EXPANDED
                sector_pm: 'Project Management', sector_transformation: 'Transformaci√≥n / Change',
                sector_product: 'Product Management', sector_banking_ops: 'Banking Operations',
                sector_payments: 'Pagos / Treasury', sector_tech: 'Tecnolog√≠a / IT',
                sector_finance: 'Finanzas / Contabilidad', sector_consulting: 'Consultor√≠a',
                sector_marketing: 'Marketing', sector_sales: 'Ventas / BizDev',
                sector_hr: 'Recursos Humanos', sector_legal: 'Legal / Compliance',
                sector_ops: 'Operaciones / Log√≠stica', sector_data: 'Data / Analytics',
                sector_other: 'Otro / An√°lisis Auto',
                
                // Levels
                level_junior: 'Junior (0-3 a√±os)', level_mid: 'Mid-Level (3-7 a√±os)',
                level_senior: 'Senior (7-12 a√±os)', level_lead: 'Lead / Manager (12-18 a√±os)',
                level_director: 'Director / Head (18+ a√±os)',
                
                // Loading
                loading_profile: 'Analizando perfil profesional...',
                loading_jobfit: 'Calculando compatibilidad...',
                loading_pdf: 'Generando informe PDF...',
                
                // Scores
                score_profile: 'Puntuaci√≥n General del Perfil', score_jobfit: 'Compatibilidad con el Puesto',
                interpretation_exceptional: 'Perfil Excepcional', interpretation_excellent: 'Perfil Excelente',
                interpretation_strong: 'Perfil Muy S√≥lido', interpretation_good: 'Perfil S√≥lido',
                interpretation_average: 'Perfil Competitivo', interpretation_developing: 'En Desarrollo',
                
                // Metrics
                metric_experience: 'Experiencia', metric_education: 'Formaci√≥n',
                metric_technical: 'Skills T√©cnicas', metric_leadership: 'Liderazgo',
                metric_achievements: 'Logros / Impacto', metric_languages: 'Idiomas',
                
                meta_experience: 'Experiencia Detectada', years: 'a√±os',
                
                // Errors
                error_sector: 'Por favor, selecciona un sector profesional',
                error_level: 'Por favor, selecciona tu nivel de experiencia',
                error_cv: 'Por favor, introduce el contenido de tu CV (m√≠nimo 100 caracteres)',
                error_mode: 'Por favor, selecciona un tipo de an√°lisis',
                error_job: 'Por favor, introduce la descripci√≥n del puesto'
            },
            en: {
                step_profile: 'Profile', step_analysis: 'Analysis', step_results: 'Results',
                sector_title: 'Professional Sector', sector_subtitle: 'Select your main area of expertise',
                level_title: 'Experience Level', level_subtitle: 'Total years of professional experience',
                cv_title: 'Your Resume', cv_subtitle: 'Copy and paste your complete CV content',
                cv_placeholder: 'Paste your resume text here...',
                load_example: 'Load example', continue_btn: 'Continue',
                analysis_type_title: 'Analysis Type', analysis_type_subtitle: 'Select what type of analysis you want',
                mode_profile_title: 'Profile Analysis', mode_profile_desc: 'Complete CV evaluation with SWOT and improvement recommendations',
                mode_jobfit_title: 'Profile + Job Fit', mode_jobfit_desc: 'Profile analysis plus comparison with a specific job offer',
                job_title: 'Job Description', job_subtitle: 'Paste the complete job description',
                job_placeholder: 'Copy the job requirements and description here...',
                back_btn: 'Back', analyze_btn: 'Analyze',
                download_pdf: 'Download PDF Report', print_report: 'Print',
                competencies_title: 'Professional Competencies', synthesis_title: 'Executive Summary',
                swot_title: 'SWOT Analysis', strengths: 'Strengths', weaknesses: 'Weaknesses',
                opportunities: 'Opportunities', threats: 'Threats', recommendations_title: 'Action Plan',
                jobfit_results_title: 'Job Compatibility Analysis',
                matching_skills: 'Matching Skills', gap_skills: 'Development Areas',
                fit_recommendations: 'Recommendations for this Position',
                cta_title: 'Need expert advice?', cta_text: 'Request a 1-hour strategic session to review these results.',
                cta_btn: 'Contact Consultant', new_analysis: 'New Analysis',
                sector_pm: 'Project Management', sector_transformation: 'Transformation / Change',
                sector_product: 'Product Management', sector_banking_ops: 'Banking Operations',
                sector_payments: 'Payments / Treasury', sector_tech: 'Technology / IT',
                sector_finance: 'Finance / Accounting', sector_consulting: 'Consulting',
                sector_marketing: 'Marketing', sector_sales: 'Sales / BizDev',
                sector_hr: 'Human Resources', sector_legal: 'Legal / Compliance',
                sector_ops: 'Operations / Logistics', sector_data: 'Data / Analytics',
                sector_other: 'Other / Auto Analysis',
                level_junior: 'Junior (0-3 years)', level_mid: 'Mid-Level (3-7 years)',
                level_senior: 'Senior (7-12 years)', level_lead: 'Lead / Manager (12-18 years)',
                level_director: 'Director / Head (18+ years)',
                loading_profile: 'Analyzing professional profile...',
                loading_jobfit: 'Calculating compatibility...',
                loading_pdf: 'Generating PDF report...',
                score_profile: 'Overall Profile Score', score_jobfit: 'Job Compatibility',
                interpretation_exceptional: 'Exceptional Profile', interpretation_excellent: 'Excellent Profile',
                interpretation_strong: 'Very Strong Profile', interpretation_good: 'Solid Profile',
                interpretation_average: 'Competitive Profile', interpretation_developing: 'Developing',
                metric_experience: 'Experience', metric_education: 'Education',
                metric_technical: 'Technical Skills', metric_leadership: 'Leadership',
                metric_achievements: 'Achievements / Impact', metric_languages: 'Languages',
                meta_experience: 'Detected Experience', years: 'years',
                error_sector: 'Please select a professional sector',
                error_level: 'Please select your experience level',
                error_cv: 'Please enter your CV content (minimum 100 characters)',
                error_mode: 'Please select an analysis type',
                error_job: 'Please enter the job description'
            },
            pt: {
                step_profile: 'Perfil', step_analysis: 'An√°lise', step_results: 'Resultados',
                sector_title: 'Setor Profissional', sector_subtitle: 'Selecione sua principal √°rea de especializa√ß√£o',
                level_title: 'N√≠vel de Experi√™ncia', level_subtitle: 'Anos totais de experi√™ncia profissional',
                cv_title: 'Seu Curr√≠culo', cv_subtitle: 'Copie e cole o conte√∫do completo do seu CV',
                cv_placeholder: 'Cole aqui o texto do seu curr√≠culo...',
                load_example: 'Carregar exemplo', continue_btn: 'Continuar',
                analysis_type_title: 'Tipo de An√°lise', analysis_type_subtitle: 'Selecione que tipo de an√°lise deseja',
                mode_profile_title: 'An√°lise de Perfil', mode_profile_desc: 'Avalia√ß√£o completa do CV com SWOT e recomenda√ß√µes de melhoria',
                mode_jobfit_title: 'Perfil + Compatibilidade', mode_jobfit_desc: 'An√°lise de perfil mais compara√ß√£o com uma oferta de trabalho espec√≠fica',
                job_title: 'Descri√ß√£o da Vaga', job_subtitle: 'Cole a descri√ß√£o completa da vaga',
                job_placeholder: 'Copie aqui os requisitos e descri√ß√£o da vaga...',
                back_btn: 'Voltar', analyze_btn: 'Analisar',
                download_pdf: 'Baixar Relat√≥rio PDF', print_report: 'Imprimir',
                competencies_title: 'Compet√™ncias Profissionais', synthesis_title: 'S√≠ntese Executiva',
                swot_title: 'An√°lise SWOT', strengths: 'For√ßas', weaknesses: 'Fraquezas',
                opportunities: 'Oportunidades', threats: 'Amea√ßas', recommendations_title: 'Plano de A√ß√£o',
                jobfit_results_title: 'An√°lise de Compatibilidade com a Vaga',
                matching_skills: 'Compet√™ncias Correspondentes', gap_skills: '√Åreas de Desenvolvimento',
                fit_recommendations: 'Recomenda√ß√µes para esta Posi√ß√£o',
                cta_title: 'Precisa de assessoria especializada?', cta_text: 'Solicite uma sess√£o estrat√©gica de 1 hora para revisar estes resultados.',
                cta_btn: 'Contatar Consultor', new_analysis: 'Nova An√°lise',
                sector_pm: 'Project Management', sector_transformation: 'Transforma√ß√£o / Change',
                sector_product: 'Product Management', sector_banking_ops: 'Banking Operations',
                sector_payments: 'Pagamentos / Treasury', sector_tech: 'Tecnologia / TI',
                sector_finance: 'Finan√ßas / Contabilidade', sector_consulting: 'Consultoria',
                sector_marketing: 'Marketing', sector_sales: 'Vendas / BizDev',
                sector_hr: 'Recursos Humanos', sector_legal: 'Jur√≠dico / Compliance',
                sector_ops: 'Opera√ß√µes / Log√≠stica', sector_data: 'Data / Analytics',
                sector_other: 'Outro / An√°lise Auto',
                level_junior: 'J√∫nior (0-3 anos)', level_mid: 'Pleno (3-7 anos)',
                level_senior: 'S√™nior (7-12 anos)', level_lead: 'Lead / Manager (12-18 anos)',
                level_director: 'Diretor / Head (18+ anos)',
                loading_profile: 'Analisando perfil profissional...',
                loading_jobfit: 'Calculando compatibilidade...',
                loading_pdf: 'Gerando relat√≥rio PDF...',
                score_profile: 'Pontua√ß√£o Geral do Perfil', score_jobfit: 'Compatibilidade com a Vaga',
                interpretation_exceptional: 'Perfil Excepcional', interpretation_excellent: 'Perfil Excelente',
                interpretation_strong: 'Perfil Muito S√≥lido', interpretation_good: 'Perfil S√≥lido',
                interpretation_average: 'Perfil Competitivo', interpretation_developing: 'Em Desenvolvimento',
                metric_experience: 'Experi√™ncia', metric_education: 'Forma√ß√£o',
                metric_technical: 'Skills T√©cnicas', metric_leadership: 'Lideran√ßa',
                metric_achievements: 'Conquistas / Impacto', metric_languages: 'Idiomas',
                meta_experience: 'Experi√™ncia Detectada', years: 'anos',
                error_sector: 'Por favor, selecione um setor profissional',
                error_level: 'Por favor, selecione seu n√≠vel de experi√™ncia',
                error_cv: 'Por favor, insira o conte√∫do do seu CV (m√≠nimo 100 caracteres)',
                error_mode: 'Por favor, selecione um tipo de an√°lise',
                error_job: 'Por favor, insira a descri√ß√£o da vaga'
            }
        };

        // --- SECTORS - EXPANDED & IMPROVED ---
        const sectors = {
            pm: {
                labelKey: 'sector_pm',
                keywords: {
                    technical: ['project management', 'pmp', 'prince2', 'agile', 'scrum', 'kanban', 'waterfall', 'jira', 'confluence', 'ms project', 'azure devops', 'asana', 'trello', 'monday', 'gantt', 'wbs', 'pert', 'critical path', 'risk management', 'stakeholder', 'pmo', 'program management', 'portfolio', 'roadmap', 'milestone', 'deliverable', 'scope', 'budget', 'timeline', 'resource', 'planning', 'scheduling', 'earned value'],
                    leadership: ['team lead', 'cross-functional', 'stakeholder management', 'communication', 'negotiation', 'conflict resolution', 'decision making', 'strategic', 'executive', 'steering committee', 'governance', 'mentoring', 'coaching'],
                    achievements: ['delivered', 'on-time', 'under budget', 'savings', 'efficiency', 'reduced', 'improved', 'implemented', 'launched', 'coordinated', 'managed', 'led', 'oversaw', 'achieved', 'exceeded', 'optimized']
                }
            },
            transformation: {
                labelKey: 'sector_transformation',
                keywords: {
                    technical: ['change management', 'transformation', 'lean', 'six sigma', 'dmaic', 'kaizen', 'continuous improvement', 'process improvement', 'bpr', 'reengineering', 'as-is', 'to-be', 'gap analysis', 'value stream', 'vsm', 'sipoc', 'root cause', 'rca', '5 whys', 'fishbone', 'kpi', 'okr', 'balanced scorecard', 'operating model', 'target operating model', 'organizational design', 'change adoption', 'prosci', 'adkar'],
                    leadership: ['change lead', 'transformation lead', 'sponsor', 'champion', 'ambassador', 'stakeholder engagement', 'resistance management', 'communication plan', 'training', 'enablement', 'culture change'],
                    achievements: ['transformed', 'redesigned', 'optimized', 'streamlined', 'reduced costs', 'improved efficiency', 'savings', 'roi', 'adoption', 'engagement', 'productivity', 'cycle time', 'lead time']
                }
            },
            product: {
                labelKey: 'sector_product',
                keywords: {
                    technical: ['product management', 'product owner', 'backlog', 'user stories', 'epics', 'roadmap', 'mvp', 'product strategy', 'product vision', 'market research', 'competitive analysis', 'customer discovery', 'user research', 'a/b testing', 'analytics', 'metrics', 'north star', 'okr', 'kpi', 'prioritization', 'moscow', 'rice', 'value proposition', 'go-to-market', 'launch', 'saas', 'b2b', 'b2c', 'agile', 'scrum', 'kanban', 'jira', 'confluence', 'figma', 'product-market fit'],
                    leadership: ['stakeholder', 'cross-functional', 'engineering', 'design', 'ux', 'customer', 'executive', 'c-level', 'presentation', 'storytelling'],
                    achievements: ['launched', 'grew', 'increased', 'revenue', 'users', 'retention', 'engagement', 'nps', 'satisfaction', 'conversion', 'acquisition']
                }
            },
            banking_ops: {
                labelKey: 'sector_banking_ops',
                keywords: {
                    technical: ['banking operations', 'back office', 'middle office', 'front office', 'operations excellence', 'service delivery', 'sla', 'kpi', 'operational risk', 'compliance', 'regulatory', 'aml', 'kyc', 'sanctions', 'fraud', 'reconciliation', 'settlement', 'clearing', 'custody', 'core banking', 'digital banking', 'fintech', 'neobank', 'payments', 'transfers', 'transactions', 'accounts', 'deposits', 'lending', 'cards', 'atm', 'branch', 'customer service', 'bpo', 'outsourcing', 'nearshoring', 'offshoring', 'vendor management', 'process automation', 'rpa', 'digitization'],
                    leadership: ['team management', 'operations manager', 'head of operations', 'director', 'service excellence', 'customer experience', 'quality assurance', 'continuous improvement', 'transformation'],
                    achievements: ['reduced', 'improved', 'efficiency', 'accuracy', 'sla', 'customer satisfaction', 'cost savings', 'headcount', 'automation', 'processing time', 'error rate', 'compliance score']
                }
            },
            payments: {
                labelKey: 'sector_payments',
                keywords: {
                    technical: ['payments', 'treasury', 'cash management', 'liquidity', 'swift', 'sepa', 'instant payments', 'target2', 'eba', 'cbpr+', 'iso20022', 'iso 20022', 'mx', 'mt', 'pacs', 'pain', 'camt', 'correspondent banking', 'nostro', 'vostro', 'fx', 'foreign exchange', 'wire transfer', 'ach', 'rtgs', 'psd2', 'psd3', 'open banking', 'api', 'payment hub', 'payment gateway', 'card payments', 'acquiring', 'issuing', 'scheme', 'visa', 'mastercard', 'reconciliation', 'exceptions', 'investigations', 'sanctions screening', 'aml', 'fraud prevention', 'euro digital', 'cbdc', 'digital euro', 'cryptocurrency', 'blockchain', 'dlt', 'stablecoin'],
                    leadership: ['payments specialist', 'treasury manager', 'payments manager', 'head of payments', 'correspondent banking', 'relationship', 'vendor', 'regulator', 'central bank'],
                    achievements: ['processed', 'volume', 'value', 'straight-through processing', 'stp', 'exception rate', 'cost per transaction', 'efficiency', 'compliance', 'migration', 'implementation', 'go-live']
                }
            },
            tech: {
                labelKey: 'sector_tech',
                keywords: {
                    technical: ['software', 'development', 'programming', 'coding', 'javascript', 'python', 'java', 'c#', '.net', 'react', 'angular', 'vue', 'node', 'typescript', 'sql', 'nosql', 'mongodb', 'postgresql', 'mysql', 'oracle', 'aws', 'azure', 'gcp', 'cloud', 'docker', 'kubernetes', 'microservices', 'api', 'rest', 'graphql', 'ci/cd', 'devops', 'gitops', 'git', 'agile', 'scrum', 'testing', 'qa', 'automation', 'infrastructure', 'networking', 'security', 'cybersecurity', 'machine learning', 'ai', 'data science', 'big data', 'etl', 'data engineering', 'architecture', 'system design'],
                    leadership: ['tech lead', 'engineering manager', 'cto', 'architect', 'team lead', 'mentor', 'code review'],
                    achievements: ['developed', 'built', 'deployed', 'scaled', 'optimized', 'reduced', 'improved', 'performance', 'uptime', 'latency', 'throughput']
                }
            },
            finance: {
                labelKey: 'sector_finance',
                keywords: {
                    technical: ['financial analysis', 'fp&a', 'budgeting', 'forecasting', 'reporting', 'financial statements', 'p&l', 'balance sheet', 'cash flow', 'variance analysis', 'cost accounting', 'management accounting', 'consolidation', 'ifrs', 'gaap', 'audit', 'internal audit', 'external audit', 'sox', 'internal controls', 'tax', 'corporate tax', 'transfer pricing', 'sap', 'oracle', 'hyperion', 'cognos', 'tableau', 'power bi', 'excel', 'financial modeling', 'valuation', 'dcf', 'm&a', 'due diligence', 'investment', 'portfolio'],
                    leadership: ['cfo', 'controller', 'finance director', 'finance manager', 'financial controller', 'business partner'],
                    achievements: ['reduced costs', 'improved', 'accuracy', 'savings', 'efficiency', 'close cycle', 'audit', 'compliance']
                }
            },
            consulting: {
                labelKey: 'sector_consulting',
                keywords: {
                    technical: ['consulting', 'strategy', 'advisory', 'implementation', 'transformation', 'due diligence', 'business case', 'feasibility', 'market analysis', 'competitive analysis', 'benchmarking', 'best practices', 'frameworks', 'methodology', 'deliverables', 'workstreams', 'project management', 'change management', 'stakeholder management', 'workshop', 'facilitation', 'presentation', 'powerpoint', 'executive summary', 'recommendations'],
                    leadership: ['partner', 'director', 'principal', 'manager', 'consultant', 'analyst', 'engagement manager', 'client relationship', 'business development', 'proposal'],
                    achievements: ['delivered', 'revenue', 'client satisfaction', 'repeat business', 'thought leadership', 'published', 'presented']
                }
            },
            marketing: {
                labelKey: 'sector_marketing',
                keywords: {
                    technical: ['marketing', 'digital marketing', 'content marketing', 'seo', 'sem', 'ppc', 'google ads', 'facebook ads', 'social media', 'email marketing', 'marketing automation', 'hubspot', 'marketo', 'salesforce', 'crm', 'analytics', 'google analytics', 'adobe analytics', 'attribution', 'funnel', 'conversion', 'leads', 'mql', 'sql', 'brand', 'branding', 'positioning', 'messaging', 'copywriting', 'content', 'video', 'podcast', 'webinar', 'events', 'pr', 'communications', 'campaign'],
                    leadership: ['cmo', 'marketing director', 'marketing manager', 'head of marketing', 'brand manager', 'creative director'],
                    achievements: ['increased', 'grew', 'leads', 'conversion', 'traffic', 'engagement', 'roi', 'roas', 'brand awareness', 'market share']
                }
            },
            sales: {
                labelKey: 'sector_sales',
                keywords: {
                    technical: ['sales', 'business development', 'account management', 'key account', 'enterprise sales', 'b2b', 'b2c', 'saas sales', 'solution selling', 'consultative selling', 'challenger sale', 'spin', 'pipeline', 'crm', 'salesforce', 'hubspot', 'prospecting', 'cold calling', 'outreach', 'demos', 'presentations', 'proposals', 'negotiation', 'closing', 'contract', 'pricing', 'quota', 'forecast', 'territory'],
                    leadership: ['sales director', 'vp sales', 'sales manager', 'head of sales', 'regional manager', 'team lead'],
                    achievements: ['revenue', 'exceeded quota', 'closed', 'won', 'new business', 'expansion', 'retention', 'churn', 'arpu', 'ltv', 'growth']
                }
            },
            hr: {
                labelKey: 'sector_hr',
                keywords: {
                    technical: ['human resources', 'hr', 'talent acquisition', 'recruiting', 'sourcing', 'employer branding', 'onboarding', 'offboarding', 'hris', 'workday', 'successfactors', 'sap hr', 'payroll', 'compensation', 'benefits', 'total rewards', 'performance management', 'talent management', 'succession planning', 'learning', 'l&d', 'training', 'development', 'organizational development', 'culture', 'engagement', 'employee experience', 'labor relations', 'employment law', 'compliance', 'diversity', 'dei', 'inclusion'],
                    leadership: ['chro', 'hr director', 'hr manager', 'hr business partner', 'hrbp', 'head of hr', 'people operations'],
                    achievements: ['hired', 'reduced turnover', 'engagement score', 'retention', 'time to hire', 'cost per hire', 'training hours', 'satisfaction']
                }
            },
            legal: {
                labelKey: 'sector_legal',
                keywords: {
                    technical: ['legal', 'compliance', 'regulatory', 'gdpr', 'data protection', 'privacy', 'contracts', 'commercial law', 'corporate law', 'employment law', 'litigation', 'dispute resolution', 'arbitration', 'mediation', 'intellectual property', 'ip', 'patents', 'trademarks', 'due diligence', 'm&a', 'governance', 'risk management', 'audit', 'internal controls', 'policy', 'procedures', 'aml', 'kyc', 'sanctions', 'financial regulation', 'banking regulation', 'mifid', 'emir', 'basel', 'solvency'],
                    leadership: ['general counsel', 'clo', 'chief compliance officer', 'cco', 'legal director', 'compliance manager', 'head of legal'],
                    achievements: ['negotiated', 'drafted', 'reviewed', 'compliance rate', 'risk reduction', 'audit findings', 'regulatory approval']
                }
            },
            ops: {
                labelKey: 'sector_ops',
                keywords: {
                    technical: ['operations', 'logistics', 'supply chain', 'procurement', 'sourcing', 'vendor management', 'inventory', 'warehouse', 'distribution', 'transportation', 'fleet', 'manufacturing', 'production', 'quality', 'lean', 'six sigma', 'tps', 'just in time', 'jit', 'erp', 'sap', 'oracle', 'demand planning', 'forecasting', 's&op', 'cost optimization', 'efficiency'],
                    leadership: ['coo', 'operations director', 'operations manager', 'supply chain director', 'logistics manager', 'plant manager'],
                    achievements: ['reduced costs', 'improved efficiency', 'on-time delivery', 'inventory turns', 'lead time', 'quality', 'defects', 'productivity']
                }
            },
            data: {
                labelKey: 'sector_data',
                keywords: {
                    technical: ['data analytics', 'business intelligence', 'bi', 'data science', 'machine learning', 'ai', 'statistics', 'sql', 'python', 'r', 'tableau', 'power bi', 'looker', 'qlik', 'excel', 'data visualization', 'dashboards', 'reporting', 'kpi', 'metrics', 'etl', 'data warehouse', 'data lake', 'big data', 'spark', 'hadoop', 'snowflake', 'databricks', 'dbt', 'data modeling', 'data governance', 'data quality', 'predictive analytics', 'prescriptive analytics', 'a/b testing', 'experimentation'],
                    leadership: ['cdo', 'chief data officer', 'data director', 'analytics manager', 'head of data', 'data lead'],
                    achievements: ['insights', 'improved decision making', 'revenue impact', 'cost savings', 'automation', 'self-service', 'adoption']
                }
            },
            other: {
                labelKey: 'sector_other',
                keywords: {
                    technical: [],
                    leadership: ['manager', 'director', 'head', 'lead', 'chief', 'vp', 'executive', 'senior', 'principal'],
                    achievements: ['delivered', 'achieved', 'improved', 'reduced', 'increased', 'managed', 'led', 'created', 'developed', 'implemented']
                }
            }
        };

        const levels = [
            { id: 'junior', labelKey: 'level_junior', yearsMin: 0, yearsMax: 3, baseScore: 50 },
            { id: 'mid', labelKey: 'level_mid', yearsMin: 3, yearsMax: 7, baseScore: 60 },
            { id: 'senior', labelKey: 'level_senior', yearsMin: 7, yearsMax: 12, baseScore: 70 },
            { id: 'lead', labelKey: 'level_lead', yearsMin: 12, yearsMax: 18, baseScore: 80 },
            { id: 'director', labelKey: 'level_director', yearsMin: 18, yearsMax: 50, baseScore: 85 }
        ];

        // --- UTILITIES ---
        function t(key) { return translations[state.lang][key] || key; }
        
        function showLoader(textKey) {
            document.getElementById('loaderText').textContent = t(textKey);
            document.getElementById('loader').classList.add('active');
        }
        
        function hideLoader() { document.getElementById('loader').classList.remove('active'); }
        
        function normalize(text) {
            return text.toLowerCase()
                .normalize('NFD').replace(/[\u0300-\u036f]/g, '')
                .replace(/[^\w\s]/g, ' ').replace(/\s+/g, ' ').trim();
        }
        
        function formatDate(lang) {
            return new Date().toLocaleDateString(
                lang === 'en' ? 'en-US' : lang === 'pt' ? 'pt-BR' : 'es-ES',
                { year: 'numeric', month: 'long', day: 'numeric' }
            );
        }

        // --- UI FUNCTIONS ---
        function changeLang(lang) { state.lang = lang; updateUI(); }
        
        function toggleTheme() {
            const isDark = document.body.dataset.theme === 'dark';
            document.body.dataset.theme = isDark ? '' : 'dark';
            document.getElementById('themeIcon').textContent = isDark ? 'üåô' : '‚òÄÔ∏è';
        }

        function goToStep(step) {
            // Validation for step 2
            if (step === 2) {
                if (!state.sector) { alert(t('error_sector')); return; }
                if (!state.level) { alert(t('error_level')); return; }
                state.cv = document.getElementById('cvInput').value.trim();
                if (state.cv.length < 100) { alert(t('error_cv')); return; }
            }
            
            // Can only go to step 3 if analysis done
            if (step === 3 && !state.profileResults) return;
            
            state.currentStep = step;
            
            document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
            document.getElementById(`panel${step}`).classList.add('active');
            
            document.querySelectorAll('.step').forEach((s, i) => {
                s.classList.remove('active', 'completed');
                if (i + 1 === step) s.classList.add('active');
                if (i + 1 < step) s.classList.add('completed');
            });
            
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function updateUI() {
            document.querySelectorAll('[data-i18n]').forEach(el => {
                el.textContent = t(el.dataset.i18n);
            });
            document.querySelectorAll('[data-i18n-placeholder]').forEach(el => {
                el.placeholder = t(el.dataset.i18nPlaceholder);
            });
            renderSectors();
            renderLevels();
            if (state.profileResults) renderResults(!!state.jobFitResults);
        }

        function renderSectors() {
            const grid = document.getElementById('sectorGrid');
            grid.innerHTML = '';
            Object.keys(sectors).forEach(key => {
                const pill = document.createElement('div');
                pill.className = 'option-pill' + (state.sector === key ? ' selected' : '');
                pill.textContent = t(sectors[key].labelKey);
                pill.onclick = () => selectSector(key);
                grid.appendChild(pill);
            });
        }

        function renderLevels() {
            const grid = document.getElementById('levelGrid');
            grid.innerHTML = '';
            levels.forEach(level => {
                const pill = document.createElement('div');
                pill.className = 'option-pill' + (state.level === level.id ? ' selected' : '');
                pill.textContent = t(level.labelKey);
                pill.onclick = () => selectLevel(level.id);
                grid.appendChild(pill);
            });
        }

        function selectSector(key) {
            state.sector = key;
            document.querySelectorAll('#sectorGrid .option-pill').forEach((p, i) => {
                p.classList.toggle('selected', Object.keys(sectors)[i] === key);
            });
        }

        function selectLevel(id) {
            state.level = id;
            document.querySelectorAll('#levelGrid .option-pill').forEach((p, i) => {
                p.classList.toggle('selected', levels[i].id === id);
            });
        }

        function selectAnalysisMode(mode) {
            state.analysisMode = mode;
            document.getElementById('modeProfile').classList.toggle('selected', mode === 'profile');
            document.getElementById('modeJobFit').classList.toggle('selected', mode === 'jobfit');
            document.getElementById('jobDescriptionCard').classList.toggle('hidden', mode !== 'jobfit');
            document.getElementById('runAnalysisBtn').disabled = false;
        }

        function updateCharCount() {
            const count = document.getElementById('cvInput').value.length;
            document.getElementById('charCount').textContent = `${count} caracteres`;
        }

        function loadExampleCV() {
            document.getElementById('cvInput').value = `RODRIGO VIDAL
PROJECT MANAGER SENIOR | TRANSFORMATION & CHANGE MANAGEMENT
Madrid, Espa√±a ‚Ä¢ LinkedIn

PERFIL PROFESIONAL
Project Manager Senior y L√≠der de Transformaci√≥n con +19 a√±os de trayectoria internacional, forjado en la disciplina de la Armada de Brasil y consolidado liderando proyectos complejos en el sector financiero.

Combino metodolog√≠as anal√≠ticas (Lean Management, Value Stream Mapping, Agile) con un liderazgo humanista. Experto en gesti√≥n de programas de transformaci√≥n, implementaci√≥n de sistemas cr√≠ticos (SWIFT/ISO20022, SAP), offshoring y gesti√≥n del cambio organizacional.

COMPETENCIAS CLAVE
Gesti√≥n de Proyectos: Planificaci√≥n estrat√©gica, control presupuestario (+4M EUR), gesti√≥n de riesgos, Agile/Waterfall, MS Project, Azure DevOps, Jira
Transformaci√≥n & Mejora Continua: Lean Management, DMAIC, SIPOC, Value Stream Mapping, Kaizen, an√°lisis AS-IS/TO-BE
Gesti√≥n del Cambio: Change management, comunicaci√≥n estrat√©gica, formaci√≥n intercultural, offshoring
Liderazgo: Equipos hasta 15 personas, stakeholder management, mentoring, comunicaci√≥n ejecutiva
Herramientas: Power BI (Certificado), SAP, Excel/Power Query, Claude AI

EXPERIENCIA PROFESIONAL

Strategic Process Manager & Change Lead
ING Espa√±a & Portugal ‚Ä¢ Madrid ‚Ä¢ 2024 ‚Äì Presente
- Offshoring Manila: Migraci√≥n estrat√©gica (5 personas). Reducci√≥n 80% BAU, SLA >95%, ahorro ‚Ç¨120K/a√±o
- Fundador del Foro de Expertos en Pagos: 57 profesionales, 8 sesiones, 95% satisfacci√≥n
- Euro Digital: Representante en grupos BCE/BdE, 3+ informes ejecutivos

Process Improvement Lead & Treasury Specialist
BME Group (SIX Group) ‚Ä¢ Madrid ‚Ä¢ 2022 ‚Äì 2024
- Proyecto ISO20022 (TARGET2/CBPR+): Coordinaci√≥n equipos t√©cnicos, roadmap 12 meses
- Value Stream Mapping: Reducci√≥n 20% tiempo de ciclo

Senior Consultant & Transformation Project Manager
Minsait (Indra) ‚Ä¢ Madrid ‚Ä¢ 2021 ‚Äì 2022
- Consolidaci√≥n plataforma pagos (+4M EUR): Migraci√≥n internacional ISO20022
- Change management para adopci√≥n cross-funcional

Product Owner ‚Äì Treasury & Cash Management
Telef√≥nica ‚Ä¢ Madrid ‚Ä¢ 2019 ‚Äì 2021
- Proyecto SAP: Gesti√≥n +200 cuentas bancarias, 20 entidades
- Banco Interno del Grupo: Creaci√≥n desde cero

Head of Treasury Operations ‚Äì Creaci√≥n desde Cero
WiZink Bank ‚Ä¢ Madrid ‚Ä¢ 2015 ‚Äì 2019
- Cre√© departamento Back Office (0‚Üí6 personas en 18 meses)
- Migraci√≥n Iberclear: Ahorro ~‚Ç¨100K/a√±o

Payment Operations Specialist
Citibank ‚Ä¢ Barcelona ‚Ä¢ 2006 ‚Äì 2015
- 9 a√±os en operaciones de pagos internacionales

Oficial de Operaciones Log√≠sticas
Armada de Brasil ‚Ä¢ 1999 ‚Äì 2006

FORMACI√ìN ACAD√âMICA
M√°ster en Project Management ‚Ä¢ OBS Business School ‚Ä¢ 2023
Executive MBA ‚Ä¢ EAE Business School ‚Ä¢ 2018
Grado en Ciencias Pol√≠ticas ‚Ä¢ Universitat de Barcelona ‚Ä¢ 2015

CERTIFICACIONES
- Especialista Lean (DMAIC, SIPOC, VSM, Kaizen) ‚Ä¢ FM2S ‚Ä¢ 2024
- Power BI & Excel Analytics ‚Ä¢ 2024
- SWIFT Payment Messages Professional ‚Ä¢ 2017

IDIOMAS
Espa√±ol Biling√ºe ‚Ä¢ Portugu√©s Nativo ‚Ä¢ Ingl√©s B2+`;
            updateCharCount();
        }

        // --- ENHANCED ANALYSIS ENGINE ---
        function analyzeProfile(cvText, sectorKey, levelId) {
            const cv = normalize(cvText);
            const cvOriginal = cvText.toLowerCase();
            const sector = sectors[sectorKey];
            const level = levels.find(l => l.id === levelId);
            
            // 1. EXPERIENCE DETECTION - More sophisticated
            let detectedYears = detectExperience(cvText);
            
            // 2. EDUCATION ANALYSIS - Enhanced
            const educationScore = analyzeEducation(cvText);
            
            // 3. TECHNICAL SKILLS - Weighted matching
            const technicalScore = analyzeSkills(cv, sector.keywords.technical, sectorKey);
            
            // 4. LEADERSHIP - Context-aware
            const leadershipScore = analyzeLeadership(cvText, sector.keywords.leadership);
            
            // 5. ACHIEVEMENTS - Impact-focused
            const achievementsScore = analyzeAchievements(cvText, sector.keywords.achievements);
            
            // 6. LANGUAGES
            const languagesScore = analyzeLanguages(cvText);
            
            // Calculate metrics
            const metrics = {
                experience: Math.min(100, calculateExperienceScore(detectedYears, level)),
                education: educationScore,
                technical: technicalScore,
                leadership: leadershipScore,
                achievements: achievementsScore,
                languages: languagesScore
            };
            
            // Overall score with level-appropriate weighting
            const weights = getWeightsForLevel(levelId);
            let overallScore = Object.keys(metrics).reduce((sum, key) => sum + metrics[key] * weights[key], 0);
            
            // Bonus for exceptional profiles
            overallScore = applyBonuses(overallScore, metrics, detectedYears, level);
            overallScore = Math.min(98, Math.round(overallScore));
            
            const swot = generateSWOT(metrics, sector, level, cvText, state.lang);
            const recommendations = generateRecommendations(metrics, sector, level, state.lang);
            const synthesis = generateSynthesis(overallScore, metrics, sector, level, detectedYears, state.lang);
            
            return {
                score: overallScore,
                metrics,
                swot,
                recommendations,
                synthesis,
                detectedYears,
                technicalKeywords: extractFoundKeywords(cv, sector.keywords.technical),
                leadershipKeywords: extractFoundKeywords(cv, sector.keywords.leadership)
            };
        }

        function detectExperience(cvText) {
            const text = cvText.toLowerCase();
            
            // Pattern 1: Explicit mention ("+19 a√±os", "19+ years")
            const explicitMatch = text.match(/[\+>]?\s*(\d{1,2})\s*\+?\s*(a√±os|years|anos|year)/i);
            if (explicitMatch) return parseInt(explicitMatch[1]);
            
            // Pattern 2: Date ranges in work history
            const yearPattern = /\b(19[89]\d|20[0-2]\d)\b/g;
            const years = [...text.matchAll(yearPattern)].map(m => parseInt(m[1]));
            if (years.length >= 2) {
                const minYear = Math.min(...years);
                const maxYear = Math.max(...years);
                const currentYear = new Date().getFullYear();
                // If the max year is within last 2 years, assume currently employed
                const endYear = maxYear >= currentYear - 2 ? currentYear : maxYear;
                return Math.min(35, endYear - minYear);
            }
            
            // Pattern 3: Count number of job positions (rough estimate)
            const jobPatterns = text.match(/\d{4}\s*[-‚Äì]\s*(presente|present|atual|current|\d{4})/gi);
            if (jobPatterns) return Math.min(25, jobPatterns.length * 3);
            
            return 5; // Default
        }

        function calculateExperienceScore(years, level) {
            const expected = (level.yearsMin + level.yearsMax) / 2;
            const ratio = years / expected;
            
            if (ratio >= 1.2) return 95; // Exceeds expectations significantly
            if (ratio >= 1.0) return 90; // Meets or exceeds
            if (ratio >= 0.8) return 80; // Close to expected
            if (ratio >= 0.6) return 70; // Some experience
            return 55; // Limited for level
        }

        function analyzeEducation(cvText) {
            let score = 40;
            const text = cvText.toLowerCase();
            
            // Degrees
            if (text.match(/\b(phd|doctorado|doutorado|doctorate|doctor)\b/)) score = 100;
            else if (text.match(/\b(executive mba|emba)\b/)) score = 95;
            else if (text.match(/\b(mba)\b/)) score = 90;
            else if (text.match(/\b(master|m√°ster|mestrado|m\.sc|msc)\b/)) score = 85;
            else if (text.match(/\b(degree|grado|licenciatura|gradua√ß√£o|bachelor|b\.sc|bsc|engineer|ingenier)\b/)) score = 70;
            else if (text.match(/\b(diploma|t√©cnico|technician|fp superior|vocational|associate)\b/)) score = 55;
            
            // Multiple degrees bonus
            const degreeCount = (text.match(/\b(master|m√°ster|mba|grado|degree|licenciatura|bachelor)\b/gi) || []).length;
            if (degreeCount >= 2) score = Math.min(100, score + 10);
            
            // Certifications bonus
            const certPatterns = [
                'pmp', 'prince2', 'scrum master', 'csm', 'psm', 'safe', 'agile',
                'six sigma', 'lean', 'green belt', 'black belt',
                'cfa', 'cpa', 'acca', 'frm',
                'aws', 'azure', 'gcp', 'google cloud',
                'cisco', 'ccna', 'ccnp',
                'itil', 'togaf', 'cobit',
                'power bi', 'tableau',
                'swift', 'iso20022', 'sepa',
                'certified', 'certification', 'certificaci√≥n', 'certificado', 'certifica√ß√£o'
            ];
            const certCount = certPatterns.filter(p => text.includes(p)).length;
            score = Math.min(100, score + certCount * 3);
            
            // Prestigious institutions bonus
            const prestigePatterns = ['ie business', 'iese', 'esade', 'insead', 'harvard', 'stanford', 'mit', 'oxford', 'cambridge', 'london business'];
            if (prestigePatterns.some(p => text.includes(p))) score = Math.min(100, score + 5);
            
            return score;
        }

        function analyzeSkills(cvNorm, keywords, sectorKey) {
            if (!keywords || keywords.length === 0) return 70; // For "other" sector
            
            let matchCount = 0;
            let weightedScore = 0;
            
            keywords.forEach((kw, index) => {
                if (cvNorm.includes(kw.toLowerCase())) {
                    matchCount++;
                    // Earlier keywords in the list are typically more important
                    const weight = 1 + (keywords.length - index) / keywords.length * 0.5;
                    weightedScore += weight;
                }
            });
            
            // Calculate percentage but with diminishing returns
            const baseRatio = matchCount / keywords.length;
            const expectedMatches = Math.min(15, keywords.length * 0.4); // Expect ~40% match
            const normalizedRatio = matchCount / expectedMatches;
            
            let score = Math.min(100, normalizedRatio * 80 + 20);
            
            // Bonus for sector-specific expertise
            if (sectorKey === 'payments' || sectorKey === 'banking_ops') {
                const corePayments = ['swift', 'sepa', 'iso20022', 'payments', 'treasury', 'target2'];
                const coreMatches = corePayments.filter(kw => cvNorm.includes(kw)).length;
                if (coreMatches >= 3) score = Math.min(100, score + 10);
            }
            
            return Math.round(score);
        }

        function analyzeLeadership(cvText, keywords) {
            const text = cvText.toLowerCase();
            let score = 50;
            
            // Team size mentions
            const teamMatch = text.match(/(\d+)\s*(personas|people|members|team|equipo)/i);
            if (teamMatch) {
                const teamSize = parseInt(teamMatch[1]);
                if (teamSize >= 15) score += 20;
                else if (teamSize >= 10) score += 15;
                else if (teamSize >= 5) score += 10;
            }
            
            // Leadership titles
            const leaderTitles = ['head', 'director', 'manager', 'lead', 'chief', 'vp', 'vice president', 'jefe', 'responsable', 'gerente', 'coordinador'];
            const titleMatches = leaderTitles.filter(t => text.includes(t)).length;
            score += titleMatches * 5;
            
            // Leadership actions
            const leaderActions = ['led', 'managed', 'directed', 'oversaw', 'supervised', 'mentored', 'coached', 'founded', 'created', 'built', 'lider√©', 'gestion√©', 'dirig√≠', 'fund√©', 'cre√©', 'constru√≠'];
            const actionMatches = leaderActions.filter(a => text.includes(a)).length;
            score += actionMatches * 3;
            
            // Stakeholder engagement
            if (text.includes('stakeholder')) score += 5;
            if (text.includes('executive') || text.includes('c-level') || text.includes('directivo')) score += 5;
            if (text.includes('cross-functional') || text.includes('multidisciplinar') || text.includes('transversal')) score += 5;
            
            // Keywords match
            if (keywords) {
                const kwMatches = keywords.filter(kw => text.includes(kw.toLowerCase())).length;
                score += kwMatches * 2;
            }
            
            return Math.min(100, score);
        }

        function analyzeAchievements(cvText, keywords) {
            const text = cvText.toLowerCase();
            let score = 40;
            
            // Quantified achievements (numbers + context)
            const quantPatterns = [
                /(\d+)\s*%/g,                           // Percentages
                /‚Ç¨\s*[\d,.]+[km]?/gi,                   // Euro amounts
                /\$\s*[\d,.]+[km]?/gi,                  // Dollar amounts
                /[\d,.]+\s*(eur|usd|gbp|brl)/gi,       // Currency mentions
                /(\d+)\s*(personas|people|team|members)/gi,  // Team sizes
                /(\d+)\s*(proyectos|projects)/gi,      // Project counts
                /(\d+)\s*(pa√≠ses|countries)/gi,        // Geographic scope
                /ahorro|savings|reducci√≥n|reduction/gi, // Cost savings mentions
                /sla\s*[>‚â•]\s*\d+%/gi,                 // SLA achievements
            ];
            
            let quantifiedCount = 0;
            quantPatterns.forEach(pattern => {
                const matches = text.match(pattern);
                if (matches) quantifiedCount += matches.length;
            });
            
            score += Math.min(30, quantifiedCount * 5);
            
            // Impact keywords
            const impactWords = ['improved', 'reduced', 'increased', 'saved', 'achieved', 'exceeded', 'optimized', 'transformed', 'created', 'launched', 'delivered', 'implemented', 'mejor√©', 'reduje', 'aument√©', 'ahorr√©', 'logr√©', 'super√©', 'optimic√©', 'transform√©', 'cre√©', 'lanc√©', 'entregu√©', 'implement√©'];
            const impactMatches = impactWords.filter(w => text.includes(w)).length;
            score += impactMatches * 2;
            
            // Specific achievements keywords from sector
            if (keywords) {
                const kwMatches = keywords.filter(kw => text.includes(kw.toLowerCase())).length;
                score += kwMatches * 3;
            }
            
            // Recognition indicators
            if (text.match(/reconoc|award|premio|recogni/i)) score += 5;
            
            return Math.min(100, score);
        }

        function analyzeLanguages(cvText) {
            const text = cvText.toLowerCase();
            let score = 40;
            
            const languages = {
                'english|ingl√©s|ingl√™s': 0,
                'spanish|espa√±ol|espanhol|castellano': 0,
                'portuguese|portugu√©s|portugu√™s': 0,
                'french|franc√©s|franc√™s|fran√ßais': 0,
                'german|alem√°n|alem√£o|deutsch': 0,
                'italian|italiano': 0,
                'chinese|chino|chin√™s|mandarin': 0,
                'japanese|japon√©s|japon√™s': 0,
                'arabic|√°rabe': 0,
                'dutch|holand√©s|neerland√©s': 0
            };
            
            let langCount = 0;
            Object.keys(languages).forEach(pattern => {
                if (new RegExp(pattern, 'i').test(text)) {
                    langCount++;
                }
            });
            
            score += langCount * 10;
            
            // Proficiency levels
            if (text.match(/\b(c2|native|nativo|bilingual|biling√ºe|fluent|fluente)\b/i)) score += 15;
            if (text.match(/\b(c1|advanced|avanzado|avan√ßado|proficient)\b/i)) score += 10;
            if (text.match(/\b(b2|upper intermediate|intermedio alto)\b/i)) score += 5;
            
            // Language certifications
            if (text.match(/\b(cambridge|toefl|ielts|dele|delf|dalf|goethe)\b/i)) score += 5;
            
            return Math.min(100, score);
        }

        function getWeightsForLevel(levelId) {
            // Weights vary by seniority level
            const weightsByLevel = {
                junior: { experience: 0.20, education: 0.25, technical: 0.25, leadership: 0.10, achievements: 0.12, languages: 0.08 },
                mid: { experience: 0.22, education: 0.20, technical: 0.25, leadership: 0.13, achievements: 0.12, languages: 0.08 },
                senior: { experience: 0.23, education: 0.15, technical: 0.22, leadership: 0.18, achievements: 0.14, languages: 0.08 },
                lead: { experience: 0.22, education: 0.12, technical: 0.18, leadership: 0.23, achievements: 0.17, languages: 0.08 },
                director: { experience: 0.20, education: 0.10, technical: 0.15, leadership: 0.28, achievements: 0.19, languages: 0.08 }
            };
            return weightsByLevel[levelId] || weightsByLevel.senior;
        }

        function applyBonuses(score, metrics, years, level) {
            let bonus = 0;
            
            // Consistency bonus: all metrics above 70
            const allAbove70 = Object.values(metrics).every(v => v >= 70);
            if (allAbove70) bonus += 5;
            
            // Excellence bonus: any metric at 95+
            const hasExcellence = Object.values(metrics).some(v => v >= 95);
            if (hasExcellence) bonus += 3;
            
            // Experience bonus for senior levels
            if ((level.id === 'lead' || level.id === 'director') && years >= 15) bonus += 3;
            
            // Well-rounded bonus: no metric below 50
            const noneBelow50 = Object.values(metrics).every(v => v >= 50);
            if (noneBelow50) bonus += 2;
            
            return score + bonus;
        }

        function extractFoundKeywords(text, keywords) {
            if (!keywords) return [];
            return keywords.filter(kw => text.includes(kw.toLowerCase()));
        }

        // --- SWOT GENERATION ---
        function generateSWOT(metrics, sector, level, cvText, lang) {
            const swot = { strengths: [], weaknesses: [], opportunities: [], threats: [] };
            const text = cvText.toLowerCase();
            const sectorName = t(sector.labelKey);
            
            // STRENGTHS
            if (metrics.experience >= 85) {
                swot.strengths.push(lang === 'es' ? 'Trayectoria profesional s√≥lida y extensa' :
                                     lang === 'en' ? 'Solid and extensive professional track record' :
                                     'Trajet√≥ria profissional s√≥lida e extensa');
            }
            if (metrics.education >= 85) {
                swot.strengths.push(lang === 'es' ? 'Formaci√≥n acad√©mica destacada con certificaciones relevantes' :
                                     lang === 'en' ? 'Outstanding academic background with relevant certifications' :
                                     'Forma√ß√£o acad√™mica destacada com certifica√ß√µes relevantes');
            }
            if (metrics.technical >= 80) {
                swot.strengths.push(lang === 'es' ? 'Competencias t√©cnicas avanzadas alineadas con el sector' :
                                     lang === 'en' ? 'Advanced technical skills aligned with the sector' :
                                     'Compet√™ncias t√©cnicas avan√ßadas alinhadas com o setor');
            }
            if (metrics.leadership >= 80) {
                swot.strengths.push(lang === 'es' ? 'Capacidad demostrada de liderazgo y gesti√≥n de equipos' :
                                     lang === 'en' ? 'Demonstrated leadership and team management ability' :
                                     'Capacidade demonstrada de lideran√ßa e gest√£o de equipes');
            }
            if (metrics.achievements >= 80) {
                swot.strengths.push(lang === 'es' ? 'Historial de logros cuantificables con impacto real' :
                                     lang === 'en' ? 'Track record of quantifiable achievements with real impact' :
                                     'Hist√≥rico de conquistas quantific√°veis com impacto real');
            }
            if (metrics.languages >= 75) {
                swot.strengths.push(lang === 'es' ? 'Perfil multiling√ºe con proyecci√≥n internacional' :
                                     lang === 'en' ? 'Multilingual profile with international projection' :
                                     'Perfil multil√≠ngue com proje√ß√£o internacional');
            }
            
            // Context-specific strengths
            if (text.includes('transformaci√≥n') || text.includes('transformation') || text.includes('change management')) {
                swot.strengths.push(lang === 'es' ? 'Experiencia en gesti√≥n del cambio y transformaci√≥n' :
                                     lang === 'en' ? 'Experience in change management and transformation' :
                                     'Experi√™ncia em gest√£o de mudan√ßas e transforma√ß√£o');
            }
            if (text.includes('offshoring') || text.includes('nearshoring') || text.includes('outsourcing')) {
                swot.strengths.push(lang === 'es' ? 'Experiencia en modelos de deslocalizaci√≥n y gesti√≥n de proveedores' :
                                     lang === 'en' ? 'Experience in offshoring models and vendor management' :
                                     'Experi√™ncia em modelos de offshoring e gest√£o de fornecedores');
            }
            
            // Ensure minimum strengths
            while (swot.strengths.length < 3) {
                const defaults = {
                    es: ['Perfil estructurado y profesional', 'Experiencia en entornos corporativos', 'Capacidad de adaptaci√≥n demostrada'],
                    en: ['Structured and professional profile', 'Experience in corporate environments', 'Demonstrated adaptability'],
                    pt: ['Perfil estruturado e profissional', 'Experi√™ncia em ambientes corporativos', 'Capacidade de adapta√ß√£o demonstrada']
                };
                swot.strengths.push(defaults[lang][swot.strengths.length]);
            }
            
            // WEAKNESSES (focus on improvement areas, not harsh criticism)
            if (metrics.technical < 60) {
                swot.weaknesses.push(lang === 'es' ? 'Oportunidad de destacar m√°s competencias t√©cnicas espec√≠ficas' :
                                      lang === 'en' ? 'Opportunity to highlight more specific technical competencies' :
                                      'Oportunidade de destacar mais compet√™ncias t√©cnicas espec√≠ficas');
            }
            if (metrics.achievements < 60) {
                swot.weaknesses.push(lang === 'es' ? 'Los logros podr√≠an cuantificarse con m√°s m√©tricas de impacto' :
                                      lang === 'en' ? 'Achievements could be quantified with more impact metrics' :
                                      'As conquistas poderiam ser quantificadas com mais m√©tricas de impacto');
            }
            if (metrics.languages < 60) {
                swot.weaknesses.push(lang === 'es' ? 'Perfil de idiomas con potencial de mejora' :
                                      lang === 'en' ? 'Language profile with improvement potential' :
                                      'Perfil de idiomas com potencial de melhoria');
            }
            if (metrics.leadership < 60 && (level.id === 'lead' || level.id === 'director')) {
                swot.weaknesses.push(lang === 'es' ? 'Destacar m√°s experiencias de liderazgo estrat√©gico' :
                                      lang === 'en' ? 'Highlight more strategic leadership experiences' :
                                      'Destacar mais experi√™ncias de lideran√ßa estrat√©gica');
            }
            
            // Ensure minimum weaknesses
            while (swot.weaknesses.length < 2) {
                const defaults = {
                    es: ['Considerar a√±adir m√°s keywords del sector objetivo', 'Actualizar con tendencias recientes del mercado'],
                    en: ['Consider adding more target sector keywords', 'Update with recent market trends'],
                    pt: ['Considerar adicionar mais palavras-chave do setor alvo', 'Atualizar com tend√™ncias recentes do mercado']
                };
                swot.weaknesses.push(defaults[lang][swot.weaknesses.length]);
            }
            
            // OPPORTUNITIES
            swot.opportunities.push(lang === 'es' ? `Alta demanda de profesionales senior en ${sectorName}` :
                                     lang === 'en' ? `High demand for senior professionals in ${sectorName}` :
                                     `Alta demanda de profissionais seniores em ${sectorName}`);
            
            swot.opportunities.push(lang === 'es' ? 'Tendencia hacia trabajo remoto ampl√≠a opciones geogr√°ficas' :
                                     lang === 'en' ? 'Remote work trend expands geographical options' :
                                     'Tend√™ncia de trabalho remoto amplia op√ß√µes geogr√°ficas');
            
            if (text.includes('digital') || text.includes('transformation') || text.includes('innovation')) {
                swot.opportunities.push(lang === 'es' ? 'Creciente inversi√≥n en transformaci√≥n digital en el sector' :
                                         lang === 'en' ? 'Growing investment in digital transformation in the sector' :
                                         'Crescente investimento em transforma√ß√£o digital no setor');
            }
            
            swot.opportunities.push(lang === 'es' ? 'Posibilidad de posicionarse como referente/thought leader' :
                                     lang === 'en' ? 'Possibility to position yourself as a thought leader' :
                                     'Possibilidade de se posicionar como refer√™ncia/thought leader');
            
            // THREATS
            swot.threats.push(lang === 'es' ? `Alta competencia para posiciones senior en ${sectorName}` :
                              lang === 'en' ? `High competition for senior positions in ${sectorName}` :
                              `Alta competi√ß√£o para posi√ß√µes seniores em ${sectorName}`);
            
            swot.threats.push(lang === 'es' ? 'Evoluci√≥n tecnol√≥gica requiere actualizaci√≥n constante' :
                              lang === 'en' ? 'Technological evolution requires constant updating' :
                              'Evolu√ß√£o tecnol√≥gica requer atualiza√ß√£o constante');
            
            if (level.id === 'lead' || level.id === 'director') {
                swot.threats.push(lang === 'es' ? 'Expectativas salariales senior pueden limitar opciones en startups' :
                                  lang === 'en' ? 'Senior salary expectations may limit options in startups' :
                                  'Expectativas salariais seniores podem limitar op√ß√µes em startups');
            }
            
            return swot;
        }

        // --- RECOMMENDATIONS ---
        function generateRecommendations(metrics, sector, level, lang) {
            const recs = [];
            const sortedMetrics = Object.entries(metrics).sort((a, b) => a[1] - b[1]);
            
            // Get 2-3 lowest metrics
            sortedMetrics.slice(0, 3).forEach(([key, value], index) => {
                if (value >= 85) return; // Skip if already high
                
                const priority = index === 0 ? 'high' : index === 1 ? 'medium' : 'low';
                const rec = getRecommendationForMetric(key, sector, lang);
                if (rec) recs.push({ priority, ...rec });
            });
            
            // Always add a general optimization recommendation
            const generalRec = {
                es: { title: 'Optimizaci√≥n para ATS', desc: 'Asegura que tu CV sea parseable por sistemas autom√°ticos: formato limpio, keywords relevantes, sin tablas complejas.' },
                en: { title: 'ATS Optimization', desc: 'Ensure your CV is parseable by automated systems: clean format, relevant keywords, no complex tables.' },
                pt: { title: 'Otimiza√ß√£o para ATS', desc: 'Garanta que seu CV seja parse√°vel por sistemas autom√°ticos: formato limpo, palavras-chave relevantes, sem tabelas complexas.' }
            };
            recs.push({ priority: 'low', ...generalRec[lang] });
            
            return recs;
        }

        function getRecommendationForMetric(metric, sector, lang) {
            const recs = {
                experience: {
                    es: { title: 'Destacar experiencia relevante', desc: 'Enfatiza proyectos espec√≠ficos con responsabilidades claras, duraci√≥n y resultados medibles.' },
                    en: { title: 'Highlight relevant experience', desc: 'Emphasize specific projects with clear responsibilities, duration and measurable results.' },
                    pt: { title: 'Destacar experi√™ncia relevante', desc: 'Enfatize projetos espec√≠ficos com responsabilidades claras, dura√ß√£o e resultados mensur√°veis.' }
                },
                education: {
                    es: { title: 'Reforzar formaci√≥n', desc: 'Considera certificaciones valoradas en el sector. Destaca formaci√≥n continua y cursos recientes.' },
                    en: { title: 'Strengthen education', desc: 'Consider certifications valued in the sector. Highlight continuous education and recent courses.' },
                    pt: { title: 'Refor√ßar forma√ß√£o', desc: 'Considere certifica√ß√µes valorizadas no setor. Destaque forma√ß√£o cont√≠nua e cursos recentes.' }
                },
                technical: {
                    es: { title: 'Ampliar competencias t√©cnicas', desc: `Incluye m√°s keywords espec√≠ficas del sector: ${sector.keywords.technical.slice(0, 6).join(', ')}.` },
                    en: { title: 'Expand technical competencies', desc: `Include more sector-specific keywords: ${sector.keywords.technical.slice(0, 6).join(', ')}.` },
                    pt: { title: 'Ampliar compet√™ncias t√©cnicas', desc: `Inclua mais palavras-chave espec√≠ficas do setor: ${sector.keywords.technical.slice(0, 6).join(', ')}.` }
                },
                leadership: {
                    es: { title: 'Destacar liderazgo', desc: 'A√±ade ejemplos concretos: tama√±o de equipos, presupuestos gestionados, stakeholders, mentoring.' },
                    en: { title: 'Highlight leadership', desc: 'Add concrete examples: team sizes, managed budgets, stakeholders, mentoring.' },
                    pt: { title: 'Destacar lideran√ßa', desc: 'Adicione exemplos concretos: tamanho de equipes, or√ßamentos gerenciados, stakeholders, mentoring.' }
                },
                achievements: {
                    es: { title: 'Cuantificar logros', desc: 'Transforma descripciones en logros con m√©tricas: %, ‚Ç¨, tiempo ahorrado, SLAs cumplidos.' },
                    en: { title: 'Quantify achievements', desc: 'Transform descriptions into achievements with metrics: %, ‚Ç¨, time saved, SLAs met.' },
                    pt: { title: 'Quantificar conquistas', desc: 'Transforme descri√ß√µes em conquistas com m√©tricas: %, ‚Ç¨, tempo economizado, SLAs cumpridos.' }
                },
                languages: {
                    es: { title: 'Potenciar idiomas', desc: 'Considera certificaciones oficiales para validar niveles. Destaca experiencias internacionales.' },
                    en: { title: 'Strengthen languages', desc: 'Consider official certifications to validate levels. Highlight international experiences.' },
                    pt: { title: 'Potenciar idiomas', desc: 'Considere certifica√ß√µes oficiais para validar n√≠veis. Destaque experi√™ncias internacionais.' }
                }
            };
            return recs[metric] ? recs[metric][lang] : null;
        }

        // --- SYNTHESIS ---
        function generateSynthesis(score, metrics, sector, level, years, lang) {
            const sectorName = t(sector.labelKey);
            const levelName = t(level.labelKey);
            
            let quality = '';
            if (score >= 90) quality = lang === 'es' ? 'excepcional' : lang === 'en' ? 'exceptional' : 'excepcional';
            else if (score >= 82) quality = lang === 'es' ? 'excelente' : lang === 'en' ? 'excellent' : 'excelente';
            else if (score >= 75) quality = lang === 'es' ? 'muy s√≥lido' : lang === 'en' ? 'very strong' : 'muito s√≥lido';
            else if (score >= 65) quality = lang === 'es' ? 's√≥lido' : lang === 'en' ? 'solid' : 's√≥lido';
            else if (score >= 50) quality = lang === 'es' ? 'competitivo' : lang === 'en' ? 'competitive' : 'competitivo';
            else quality = lang === 'es' ? 'en desarrollo' : lang === 'en' ? 'developing' : 'em desenvolvimento';
            
            const sortedMetrics = Object.entries(metrics).sort((a, b) => b[1] - a[1]);
            const strongest = sortedMetrics[0][0];
            const weakest = sortedMetrics[sortedMetrics.length - 1][0];
            
            const metricNames = {
                experience: { es: 'experiencia profesional', en: 'professional experience', pt: 'experi√™ncia profissional' },
                education: { es: 'formaci√≥n acad√©mica', en: 'academic education', pt: 'forma√ß√£o acad√™mica' },
                technical: { es: 'competencias t√©cnicas', en: 'technical skills', pt: 'compet√™ncias t√©cnicas' },
                leadership: { es: 'capacidad de liderazgo', en: 'leadership capacity', pt: 'capacidade de lideran√ßa' },
                achievements: { es: 'logros e impacto', en: 'achievements and impact', pt: 'conquistas e impacto' },
                languages: { es: 'perfil de idiomas', en: 'language profile', pt: 'perfil de idiomas' }
            };
            
            const templates = {
                es: `Perfil profesional ${quality} para ${sectorName} en nivel ${levelName}, con ${years}+ a√±os de experiencia demostrable. Tu punto m√°s destacado es ${metricNames[strongest].es} (${Math.round(metrics[strongest])}%), mientras que ${metricNames[weakest].es} (${Math.round(metrics[weakest])}%) ofrece el mayor potencial de optimizaci√≥n. Con una puntuaci√≥n global del ${score}%, tu perfil est√° ${score >= 75 ? 'muy bien posicionado para roles de alto nivel en el mercado actual' : score >= 60 ? 'bien posicionado con oportunidades claras de diferenciaci√≥n' : 'en desarrollo con un plan de mejora claro identificado'}.`,
                
                en: `${quality.charAt(0).toUpperCase() + quality.slice(1)} professional profile for ${sectorName} at ${levelName} level, with ${years}+ years of demonstrable experience. Your strongest point is ${metricNames[strongest].en} (${Math.round(metrics[strongest])}%), while ${metricNames[weakest].en} (${Math.round(metrics[weakest])}%) offers the greatest optimization potential. With an overall score of ${score}%, your profile is ${score >= 75 ? 'very well positioned for senior roles in the current market' : score >= 60 ? 'well positioned with clear differentiation opportunities' : 'developing with a clear improvement plan identified'}.`,
                
                pt: `Perfil profissional ${quality} para ${sectorName} em n√≠vel ${levelName}, com ${years}+ anos de experi√™ncia demonstr√°vel. Seu ponto mais destacado √© ${metricNames[strongest].pt} (${Math.round(metrics[strongest])}%), enquanto ${metricNames[weakest].pt} (${Math.round(metrics[weakest])}%) oferece o maior potencial de otimiza√ß√£o. Com uma pontua√ß√£o global de ${score}%, seu perfil est√° ${score >= 75 ? 'muito bem posicionado para fun√ß√µes de alto n√≠vel no mercado atual' : score >= 60 ? 'bem posicionado com oportunidades claras de diferencia√ß√£o' : 'em desenvolvimento com um plano de melhoria claro identificado'}.`
            };
            
            return templates[lang];
        }

        // --- JOB FIT ANALYSIS ---
        function analyzeJobFit(cvText, jobText, profileResults) {
            const cvNorm = normalize(cvText);
            const jobNorm = normalize(jobText);
            const jobLower = jobText.toLowerCase();
            
            // Extract key requirements from job description
            const requirements = extractRequirements(jobText);
            
            // Match against CV
            const matching = [];
            const gaps = [];
            
            requirements.forEach(req => {
                if (cvNorm.includes(req.toLowerCase()) || cvNorm.includes(req.replace(/[-_]/g, ' ').toLowerCase())) {
                    matching.push(req);
                } else {
                    // Check for synonyms/related terms
                    const synonymMatched = checkSynonyms(req, cvNorm);
                    if (synonymMatched) {
                        matching.push(req);
                    } else {
                        gaps.push(req);
                    }
                }
            });
            
            // Calculate fit score with multiple factors
            const requirementMatchRatio = requirements.length > 0 ? matching.length / requirements.length : 0;
            
            // Profile score contribution (40%)
            const profileContribution = profileResults.score * 0.4;
            
            // Requirement match contribution (45%)
            const matchContribution = requirementMatchRatio * 45;
            
            // Experience alignment bonus (15%)
            let experienceBonus = 0;
            const yearsRequired = extractYearsRequired(jobText);
            if (yearsRequired && profileResults.detectedYears >= yearsRequired) {
                experienceBonus = 15;
            } else if (yearsRequired && profileResults.detectedYears >= yearsRequired * 0.7) {
                experienceBonus = 10;
            } else {
                experienceBonus = 5;
            }
            
            const fitScore = Math.min(98, Math.round(profileContribution + matchContribution + experienceBonus));
            
            // Generate specific recommendations
            const fitRecommendations = generateFitRecommendations(matching, gaps, state.lang);
            
            return {
                score: fitScore,
                matching,
                gaps: gaps.slice(0, 10), // Limit displayed gaps
                recommendations: fitRecommendations
            };
        }

        function extractRequirements(jobText) {
            const text = jobText.toLowerCase();
            const requirements = new Set();
            
            // Add sector keywords that appear in job
            if (state.sector && sectors[state.sector]) {
                sectors[state.sector].keywords.technical.forEach(kw => {
                    if (text.includes(kw.toLowerCase())) requirements.add(kw);
                });
                sectors[state.sector].keywords.leadership.forEach(kw => {
                    if (text.includes(kw.toLowerCase())) requirements.add(kw);
                });
            }
            
            // Common requirement patterns
            const commonSkills = [
                'leadership', 'management', 'team', 'strategic', 'analytical',
                'communication', 'stakeholder', 'project management', 'agile', 'scrum',
                'excel', 'powerpoint', 'data-driven', 'process', 'improvement',
                'compliance', 'regulatory', 'risk', 'budget', 'operations',
                'customer', 'service', 'excellence', 'english', 'spanish',
                'cross-functional', 'international', 'global'
            ];
            
            commonSkills.forEach(skill => {
                if (text.includes(skill)) requirements.add(skill);
            });
            
            return Array.from(requirements);
        }

        function extractYearsRequired(jobText) {
            const match = jobText.match(/(\d+)\+?\s*(years?|a√±os?|anos?)/i);
            return match ? parseInt(match[1]) : null;
        }

        function checkSynonyms(term, cvText) {
            const synonymGroups = {
                'leadership': ['l√≠der', 'liderazgo', 'dirigir', 'lead', 'manager', 'head'],
                'team': ['equipo', 'team', 'grupo', 'colaboradores'],
                'management': ['gesti√≥n', 'administraci√≥n', 'management', 'gerencia'],
                'strategic': ['estrat√©gico', 'estrategia', 'strategy'],
                'analytical': ['anal√≠tico', 'an√°lisis', 'analysis', 'data'],
                'communication': ['comunicaci√≥n', 'comunicar', 'presenting'],
                'stakeholder': ['interesados', 'stakeholder', 'partes interesadas'],
                'improvement': ['mejora', 'optimizaci√≥n', 'optimization', 'kaizen', 'lean'],
                'operations': ['operaciones', 'operacional', 'operational'],
                'compliance': ['cumplimiento', 'regulatorio', 'regulatory'],
                'global': ['internacional', 'multinacional', 'worldwide'],
                'customer': ['cliente', 'customer', 'servicio']
            };
            
            const termLower = term.toLowerCase();
            for (const [key, synonyms] of Object.entries(synonymGroups)) {
                if (termLower.includes(key) || synonyms.some(s => termLower.includes(s))) {
                    if (synonyms.some(s => cvText.includes(s))) return true;
                    if (cvText.includes(key)) return true;
                }
            }
            return false;
        }

        function generateFitRecommendations(matching, gaps, lang) {
            const templates = {
                es: {
                    intro: matching.length > 0 ? 
                        `Tu perfil coincide bien con los requisitos clave: ${matching.slice(0, 5).join(', ')}.` :
                        'Personaliza tu CV para este puesto espec√≠fico.',
                    gaps: gaps.length > 0 ? 
                        ` Para fortalecer tu candidatura, considera desarrollar o destacar: ${gaps.slice(0, 4).join(', ')}.` : 
                        ' Tu perfil cubre los requisitos principales.',
                    action: ' En tu carta de presentaci√≥n, vincula tus logros cuantificados con las necesidades espec√≠ficas del puesto.'
                },
                en: {
                    intro: matching.length > 0 ? 
                        `Your profile matches well with key requirements: ${matching.slice(0, 5).join(', ')}.` :
                        'Customize your CV for this specific position.',
                    gaps: gaps.length > 0 ? 
                        ` To strengthen your application, consider developing or highlighting: ${gaps.slice(0, 4).join(', ')}.` : 
                        ' Your profile covers the main requirements.',
                    action: ' In your cover letter, link your quantified achievements to the specific needs of the position.'
                },
                pt: {
                    intro: matching.length > 0 ? 
                        `Seu perfil coincide bem com os requisitos-chave: ${matching.slice(0, 5).join(', ')}.` :
                        'Personalize seu CV para esta posi√ß√£o espec√≠fica.',
                    gaps: gaps.length > 0 ? 
                        ` Para fortalecer sua candidatura, considere desenvolver ou destacar: ${gaps.slice(0, 4).join(', ')}.` : 
                        ' Seu perfil cobre os requisitos principais.',
                    action: ' Na sua carta de apresenta√ß√£o, vincule suas conquistas quantificadas √†s necessidades espec√≠ficas da posi√ß√£o.'
                }
            };
            
            return templates[lang].intro + templates[lang].gaps + templates[lang].action;
        }

        // --- MAIN ANALYSIS ---
        async function runAnalysis() {
            if (!state.analysisMode) {
                alert(t('error_mode'));
                return;
            }
            
            if (state.analysisMode === 'jobfit') {
                const jobText = document.getElementById('jobInput').value.trim();
                if (jobText.length < 50) {
                    alert(t('error_job'));
                    return;
                }
                state.job = jobText;
            }
            
            showLoader('loading_profile');
            await new Promise(resolve => setTimeout(resolve, 1500));
            
            state.profileResults = analyzeProfile(state.cv, state.sector, state.level);
            
            if (state.analysisMode === 'jobfit') {
                showLoader('loading_jobfit');
                await new Promise(resolve => setTimeout(resolve, 800));
                state.jobFitResults = analyzeJobFit(state.cv, state.job, state.profileResults);
            }
            
            hideLoader();
            renderResults(state.analysisMode === 'jobfit');
            goToStep(3);
        }

        // --- RENDERING ---
        function renderResults(includeJobFit) {
            const results = state.profileResults;
            const score = includeJobFit && state.jobFitResults ? state.jobFitResults.score : results.score;
            
            document.getElementById('resultsDate').textContent = formatDate(state.lang);
            document.getElementById('mainScore').textContent = score + '%';
            document.getElementById('scoreLabel').textContent = includeJobFit ? t('score_jobfit') : t('score_profile');
            
            let interpretation = '';
            if (score >= 90) interpretation = t('interpretation_exceptional');
            else if (score >= 82) interpretation = t('interpretation_excellent');
            else if (score >= 75) interpretation = t('interpretation_strong');
            else if (score >= 65) interpretation = t('interpretation_good');
            else if (score >= 50) interpretation = t('interpretation_average');
            else interpretation = t('interpretation_developing');
            document.getElementById('scoreInterpretation').textContent = interpretation;
            
            document.getElementById('metaSector').textContent = t(sectors[state.sector].labelKey);
            document.getElementById('metaLevel').textContent = t(levels.find(l => l.id === state.level).labelKey);
            document.getElementById('metaYears').textContent = `${results.detectedYears}+ ${t('years')}`;
            
            renderScoreGauge(score);
            renderRadarChart(results.metrics);
            renderMetrics(results.metrics);
            document.getElementById('synthesisText').textContent = results.synthesis;
            renderSWOT(results.swot);
            renderRecommendations(results.recommendations);
            
            const jobFitSection = document.getElementById('jobFitResults');
            if (includeJobFit && state.jobFitResults) {
                jobFitSection.classList.remove('hidden');
                renderJobFit(state.jobFitResults);
            } else {
                jobFitSection.classList.add('hidden');
            }
        }

        function renderScoreGauge(score) {
            const canvas = document.getElementById('scoreGauge');
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, 200, 200);
            
            const centerX = 100, centerY = 100, radius = 85, lineWidth = 14;
            
            ctx.beginPath();
            ctx.arc(centerX, centerY, radius, 0.75 * Math.PI, 2.25 * Math.PI);
            ctx.strokeStyle = '#e2e8f0';
            ctx.lineWidth = lineWidth;
            ctx.lineCap = 'round';
            ctx.stroke();
            
            const scoreAngle = 0.75 * Math.PI + (score / 100) * 1.5 * Math.PI;
            ctx.beginPath();
            ctx.arc(centerX, centerY, radius, 0.75 * Math.PI, scoreAngle);
            const gradient = ctx.createLinearGradient(0, 0, 200, 200);
            gradient.addColorStop(0, '#d4a853');
            gradient.addColorStop(1, '#a37633');
            ctx.strokeStyle = gradient;
            ctx.lineWidth = lineWidth;
            ctx.lineCap = 'round';
            ctx.stroke();
        }

        function renderRadarChart(metrics) {
            const ctx = document.getElementById('radarChart').getContext('2d');
            if (state.charts.radar) state.charts.radar.destroy();
            
            const labels = [
                t('metric_experience'), t('metric_education'), t('metric_technical'),
                t('metric_leadership'), t('metric_achievements'), t('metric_languages')
            ];
            const data = [metrics.experience, metrics.education, metrics.technical, metrics.leadership, metrics.achievements, metrics.languages];
            
            state.charts.radar = new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: 'rgba(212, 168, 83, 0.2)',
                        borderColor: '#d4a853',
                        borderWidth: 2,
                        pointBackgroundColor: '#d4a853',
                        pointBorderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        r: {
                            beginAtZero: true,
                            max: 100,
                            ticks: { stepSize: 25, font: { size: 10 } },
                            pointLabels: { font: { size: 11, family: "'DM Sans', sans-serif" } },
                            grid: { color: 'rgba(0, 0, 0, 0.1)' }
                        }
                    }
                }
            });
        }

        function renderMetrics(metrics) {
            const container = document.getElementById('metricsContainer');
            container.innerHTML = '';
            
            const config = [
                { key: 'experience', label: t('metric_experience'), color: '#d4a853' },
                { key: 'education', label: t('metric_education'), color: '#a37633' },
                { key: 'technical', label: t('metric_technical'), color: '#059669' },
                { key: 'leadership', label: t('metric_leadership'), color: '#7c3aed' },
                { key: 'achievements', label: t('metric_achievements'), color: '#0284c7' },
                { key: 'languages', label: t('metric_languages'), color: '#db2777' }
            ];
            
            config.forEach(({ key, label, color }) => {
                const value = Math.round(metrics[key]);
                container.innerHTML += `
                    <div class="metric-item">
                        <span class="metric-label">${label}</span>
                        <div class="metric-bar">
                            <div class="metric-fill" style="width: ${value}%; background: ${color};"></div>
                        </div>
                        <span class="metric-value">${value}%</span>
                    </div>`;
            });
        }

        function renderSWOT(swot) {
            ['strengths', 'weaknesses', 'opportunities', 'threats'].forEach(key => {
                document.getElementById(`${key}List`).innerHTML = swot[key].map(item => `<li>${item}</li>`).join('');
            });
        }

        function renderRecommendations(recommendations) {
            document.getElementById('recommendationsList').innerHTML = recommendations.map((rec, i) => `
                <li class="rec-item">
                    <div class="rec-priority ${rec.priority}">${i + 1}</div>
                    <div class="rec-content">
                        <div class="rec-title">${rec.title}</div>
                        <div class="rec-desc">${rec.desc}</div>
                    </div>
                </li>`).join('');
        }

        function renderJobFit(fitResults) {
            document.getElementById('matchingSkills').innerHTML = fitResults.matching.map(skill => 
                `<span class="tag match">${skill}</span>`).join('');
            document.getElementById('gapSkills').innerHTML = fitResults.gaps.map(skill => 
                `<span class="tag missing">${skill}</span>`).join('');
            document.getElementById('fitRecommendationsText').textContent = fitResults.recommendations;
        }

        // --- PDF ---
        async function generatePDF() {
            showLoader('loading_pdf');
            
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF('p', 'mm', 'a4');
            const pageWidth = 210, pageHeight = 297, margin = 10;
            
            const originalTheme = document.body.dataset.theme;
            document.body.dataset.theme = '';
            await new Promise(resolve => setTimeout(resolve, 100));
            
            const sections = [
                document.getElementById('resultsHeader'),
                document.getElementById('competenciesCard'),
                document.getElementById('synthesisCard'),
                document.getElementById('swotCard'),
                document.getElementById('recommendationsCard')
            ];
            
            if (!document.getElementById('jobFitResults').classList.contains('hidden')) {
                sections.push(document.getElementById('jobFitResults'));
            }
            sections.push(document.getElementById('resultsFooter'));
            
            let currentY = margin, pageNum = 1;
            
            for (let i = 0; i < sections.length; i++) {
                const section = sections[i];
                if (!section) continue;
                
                try {
                    const canvas = await html2canvas(section, {
                        scale: 2, useCORS: true, allowTaint: true,
                        backgroundColor: '#fefdfb', logging: false
                    });
                    
                    const imgWidth = pageWidth - margin * 2;
                    const imgHeight = (canvas.height * imgWidth) / canvas.width;
                    
                    if (currentY + imgHeight > pageHeight - margin && i > 0) {
                        pdf.setFontSize(8);
                        pdf.setTextColor(150);
                        pdf.text(`${pageNum}`, pageWidth / 2, pageHeight - 5, { align: 'center' });
                        pdf.addPage();
                        pageNum++;
                        currentY = margin;
                    }
                    
                    pdf.addImage(canvas.toDataURL('image/png'), 'PNG', margin, currentY, imgWidth, imgHeight);
                    currentY += imgHeight + 5;
                } catch (error) {
                    console.error('Error capturing section:', error);
                }
            }
            
            pdf.setFontSize(8);
            pdf.setTextColor(150);
            pdf.text(`${pageNum}`, pageWidth / 2, pageHeight - 5, { align: 'center' });
            
            document.body.dataset.theme = originalTheme;
            pdf.save(`RV_Profile_Analysis_${new Date().toISOString().split('T')[0]}.pdf`);
            hideLoader();
        }

        // --- CONTACT ---
        function contactConsultant() {
            const subject = encodeURIComponent('Solicitud de Asesoramiento - RV Profile Studio');
            const body = encodeURIComponent(`Hola,\n\nHe realizado un an√°lisis de mi perfil profesional con RV Profile Studio y me gustar√≠a solicitar una sesi√≥n de asesoramiento.\n\nMi puntuaci√≥n fue: ${state.profileResults?.score || 'N/A'}%\nSector: ${state.sector ? t(sectors[state.sector].labelKey) : 'N/A'}\n\nQuedo a la espera de su respuesta.\n\nSaludos.`);
            window.open(`mailto:${CONFIG.consultantEmail}?subject=${subject}&body=${body}`);
        }

        function resetApp() {
            state = { lang: state.lang, sector: null, level: null, cv: '', job: '', analysisMode: null, profileResults: null, jobFitResults: null, currentStep: 1, charts: {} };
            document.getElementById('cvInput').value = '';
            document.getElementById('jobInput').value = '';
            document.getElementById('charCount').textContent = '0 caracteres';
            document.querySelectorAll('.option-pill, .analysis-mode-card').forEach(p => p.classList.remove('selected'));
            document.getElementById('jobDescriptionCard').classList.add('hidden');
            document.getElementById('runAnalysisBtn').disabled = true;
            document.querySelectorAll('.step').forEach((s, i) => {
                s.classList.remove('active', 'completed');
                if (i === 0) s.classList.add('active');
            });
            goToStep(1);
        }

        // --- INIT ---
        function init() {
            renderSectors();
            renderLevels();
            document.getElementById('cvInput').addEventListener('input', updateCharCount);
            if (window.matchMedia?.('(prefers-color-scheme: dark)').matches) {
                document.body.dataset.theme = 'dark';
                document.getElementById('themeIcon').textContent = '‚òÄÔ∏è';
            }
            console.log('RV Profile Studio v' + CONFIG.version + ' initialized');
        }

        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
